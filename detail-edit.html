<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Route Detail Edit</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto; max-width: 900px; margin: 20px auto; padding: 0 12px; color:#111827; }
    header { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    h1 { font-size:20px; margin:0; }
    .btn { padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; gap:4px; text-decoration:none; color:#111827; }
    .btn:visited { color:#111827; text-decoration:none; }
    .btn:hover { background:#f3f4f6; color:#111827; text-decoration:none; }
    .btn.danger { border-color:#fecaca; color:#991b1b; }
    .btn.danger:hover { background:#fee2e2; }
    .btn[disabled] { opacity:0.6; cursor:not-allowed; }
    .card { border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin:10px 0; background:#fff; }
    label { display:block; font-size:13px; color:#6b7280; margin-bottom:6px; }
    input[type="text"] { width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; }
    .muted { color:#6b7280; }
    #status { border:1px solid #e5e7eb; background:#f9fafb; border-radius:8px; padding:8px 10px; margin:10px 0; font-size:13px; }
    #status.error { border-color:#fecaca; background:#fef2f2; color:#991b1b; }
    #status.success { border-color:#bbf7d0; background:#f0fdf4; color:#166534; }
    .photos { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px; }
    .photo-card { border:1px solid #e5e7eb; border-radius:8px; padding:8px; background:#fff; display:flex; flex-direction:column; gap:6px; }
    .photo-card img { width:100%; height:100px; object-fit:cover; border-radius:6px; background:#f3f4f6; }
    .photo-card .meta { font-size:12px; color:#6b7280; }
    .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .section-title { font-weight:700; margin:0 0 8px; }
    .actions { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:10px; }
  </style>

  <script src="js/version.js"></script>
  <script>
    if (typeof window.APP_VERSION === 'undefined' || !window.APP_VERSION) {
      window.APP_VERSION = new Date().toISOString().slice(0,10) + '-dev';
    }
    window.APP_VERSION = String(window.APP_VERSION) + '-2026-01-13-01-detail-edit';
  </script>
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="js/app-common.js"></script>
  <script src="js/auth-common.js"></script>
</head>
<body>
  <header>
    <div>
      <h1>ルート編集</h1>
      <div class="muted" style="font-size:12px;">detail編集専用</div>
    </div>
    <div class="row">
      <a id="lnBack" class="btn" href="#">← detailへ戻る</a>
      <a id="lnPhotoList" class="btn" href="#">写真一覧へ</a>
    </div>
  </header>

  <div id="status" class="muted">初期化中…</div>

  <section class="card">
    <h2 class="section-title">ルート名</h2>
    <label for="routeName">ルート名</label>
    <input id="routeName" type="text" placeholder="ルート名称" />
    <div class="actions">
      <button id="btnSave" class="btn">保存</button>
    </div>
  </section>

  <section class="card">
    <h2 class="section-title">写真</h2>
    <div id="photoHint" class="muted" style="font-size:12px; margin-bottom:8px;"></div>
    <div id="photoList" class="photos"></div>
    <div id="morePhotos" class="muted" style="margin-top:8px; display:none;">もっと表示（未実装）</div>
  </section>

  <footer class="muted" style="margin-top:14px;">v: <code id="ver"></code></footer>

  <script>
    document.getElementById('ver').textContent = window.APP_VERSION || '';

    const SUPABASE_URL = 'https://cqiqhczxuiyakptdjowr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxaXFoY3p4dWl5YWtwdGRqb3dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NzAwNzMsImV4cCI6MjA3MzM0NjA3M30.vCFQoQnsClINKa5tQAz-rNnF5XLEukmn_Nl0Err5k3k';

    const sb = window.supabaseClient || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false }
    });
    if (!sb) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = 'ERROR: supabaseClient が初期化されていません';
      statusEl.classList.add('error');
    }

    AuthCommon.init(sb, { redirectUrl: 'detail-edit.html' });

    const V = () => encodeURIComponent(window.APP_VERSION || '');
    const params = new URLSearchParams(location.search);
    const routeId = params.get('id');

    const statusEl = document.getElementById('status');
    const routeNameInput = document.getElementById('routeName');
    const btnSave = document.getElementById('btnSave');
    const photoListEl = document.getElementById('photoList');
    const photoHintEl = document.getElementById('photoHint');
    const morePhotosEl = document.getElementById('morePhotos');
    const lnBack = document.getElementById('lnBack');
    const lnPhotoList = document.getElementById('lnPhotoList');

    let ensuredAccountId = null;
    let ownerAccountId = null;
    let canEdit = false;

    function setStatus(msg, type = '') {
      statusEl.textContent = msg;
      statusEl.classList.remove('error', 'success');
      if (type) statusEl.classList.add(type);
    }

    function setUiEnabled(enabled) {
      routeNameInput.disabled = !enabled;
      btnSave.disabled = !enabled;
      document.querySelectorAll('[data-photo-delete]').forEach(btn => {
        btn.disabled = !enabled;
      });
    }

    function escapeHtml(str) {
      return (str ?? '').replace(/[&<>"']/g, (c) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[c] || c);
    }

    async function ensureAuthOrStop() {
      const ensureAuth = AppCommon.createEnsureAuth({
        supabase: sb,
        getAccountId: () => AuthCommon.getMyAccountId(sb)
      });
      try {
        const ensured = await ensureAuth();
        ensuredAccountId = ensured.accountId;
        return ensured;
      } catch (e) {
        setStatus('未ログインです。ログインしてください', 'error');
        setUiEnabled(false);
        return null;
      }
    }

    async function loadRoute() {
      if (!routeId) {
        setStatus('route_id が指定されていません', 'error');
        return null;
      }
      setStatus('ルート情報を読み込み中…');
      const { data, error } = await sb
        .from('routes')
        .select('id,name,owner_account_id,account_id')
        .eq('id', routeId)
        .maybeSingle();
      if (error || !data) {
        setStatus('ルート情報の取得に失敗しました', 'error');
        console.error(error);
        return null;
      }
      ownerAccountId = data.owner_account_id || data.account_id || null;
      routeNameInput.value = data.name || '';
      return data;
    }

    function resolveEditPermission() {
      if (!ensuredAccountId || !ownerAccountId) return false;
      return String(ensuredAccountId) === String(ownerAccountId);
    }

    async function saveRouteName() {
      if (!canEdit) return;
      const newName = routeNameInput.value.trim();
      if (!newName) {
        setStatus('ルート名を入力してください', 'error');
        return;
      }
      setStatus('保存中…');
      const { error } = await sb
        .from('routes')
        .update({ name: newName })
        .eq('id', routeId);
      if (error) {
        setStatus('保存に失敗しました: ' + (error.message || error), 'error');
        return;
      }
      setStatus('保存しました', 'success');
    }

    function renderPhotos(rows, totalCount) {
      if (!rows || rows.length === 0) {
        photoHintEl.textContent = '写真がありません。';
        photoListEl.innerHTML = '';
        morePhotosEl.style.display = 'none';
        return;
      }
      photoHintEl.textContent = `最新${rows.length}枚`;
      photoListEl.innerHTML = rows.map((row) => {
        const thumbSrc = row.thumb_url || row.image_url;
        const when = row.taken_at ? new Date(row.taken_at).toLocaleString() : '撮影時刻不明';
        return `
          <div class="photo-card">
            <img src="${escapeHtml(thumbSrc)}" alt="photo" />
            <div class="meta">${escapeHtml(when)}</div>
            <button class="btn danger" data-photo-delete data-photo-id="${escapeHtml(row.id)}">削除</button>
          </div>
        `;
      }).join('');

      morePhotosEl.style.display = totalCount > rows.length ? 'block' : 'none';

      document.querySelectorAll('[data-photo-delete]').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!canEdit) return;
          const pid = btn.getAttribute('data-photo-id');
          if (!pid) return;
          if (!confirm('この写真を削除しますか？')) return;
          await deletePhoto(pid);
        });
      });
    }

    async function fetchPhotos() {
      const { data, error, count } = await sb
        .from('route_spot_photos')
        .select('id,image_url,thumb_url,taken_at,lat,lng', { count: 'exact' })
        .eq('route_id', routeId)
        .is('deleted_at', null)
        .order('taken_at', { ascending: false })
        .limit(12);
      if (error) throw error;
      return { rows: data || [], count: typeof count === 'number' ? count : (data || []).length };
    }

    async function loadPhotos() {
      if (!routeId) return;
      try {
        const { rows, count } = await fetchPhotos();
        renderPhotos(rows, count);
        setUiEnabled(canEdit);
      } catch (e) {
        setStatus('写真の取得に失敗しました: ' + (e?.message || e), 'error');
        console.error(e);
      }
    }

    async function deletePhoto(photoId) {
      setStatus('削除中…');
      try {
        const { data: { user } } = await sb.auth.getUser();
        const { error } = await sb
          .from('route_spot_photos')
          .update({ deleted_at: new Date().toISOString(), deleted_by: user?.id || null })
          .eq('id', photoId);
        if (error) throw error;
        setStatus('削除しました', 'success');
        await loadPhotos();
      } catch (e) {
        setStatus('削除に失敗しました: ' + (e?.message || e), 'error');
        console.error(e);
      }
    }

    async function init() {
      if (!routeId) {
        setStatus('route_id が指定されていません', 'error');
        return;
      }

      lnBack.href = `detail.html?id=${encodeURIComponent(routeId)}&kind=route&v=${V()}`;
      lnPhotoList.href = `route-photos.html?route_id=${encodeURIComponent(routeId)}&v=${V()}`;

      const ensured = await ensureAuthOrStop();
      if (!ensured) return;

      const route = await loadRoute();
      if (!route) return;

      canEdit = resolveEditPermission();
      if (!canEdit) {
        setStatus('権限がありません', 'error');
        setUiEnabled(false);
      } else {
        setStatus('編集できます');
        setUiEnabled(true);
      }

      await loadPhotos();
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!sb) return;
      btnSave.addEventListener('click', saveRouteName);
      init();
    }, { once:true });
  </script>
</body>
</html>
