<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Route MVP – GPS実走テスト（三鷹駅↔玉川上水・井の頭公園サンプル）</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html,body,#map { height: 100%; margin: 0; }
    .ui { position: fixed; left: 8px; right: 8px; top: env(safe-area-inset-top,8px); display:flex; gap:8px; z-index:1000; }
    .ui .badge { padding:6px 10px; border-radius:999px; font-weight:600; background:#e2e8f0; }
    .ui .badge.ok { background:#d1fae5; color:#065f46; }
    .ui .badge.warn { background:#fef3c7; color:#92400e; }
    .ui .badge.off { background:#fee2e2; color:#991b1b; }
    .dock { position: fixed; right: 8px; bottom: 8px; display:flex; flex-direction:column; gap:8px; z-index:1000; }
    .btn { background:#111827; color:#fff; border:none; padding:10px 12px; border-radius:12px; font-size:14px; }
    .btn.ghost { background:#ffffff; color:#111827; border:1px solid #e5e7eb; }
    .hint { position: fixed; left: 8px; bottom: 8px; z-index:1000; background:#ffffffdd; padding:6px 10px; border-radius:10px; font-size:12px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="ui">
    <div id="courseBadge" class="badge">準備中…</div>
  </div>

  <div class="dock">
    <button id="locateBtn" class="btn">📍 現在地</button>
    <button id="startBtn" class="btn">▶ 開始</button>
    <button id="stopBtn" class="btn ghost">⏸ 停止</button>
    <button id="followBtn" class="btn ghost">🔁 追従 ON</button>
  </div>

  <div class="hint">📌 サンプルは「三鷹駅 →（北側）玉川上水沿いで井の頭文化園横 → 井の頭公園西側入口（グラウンド付近） → 折返し（南側）玉川上水沿い → 三鷹駅」。必要に応じて地図タップで点を足して微修正できます。</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
    const map = L.map('map').setView([35.7015, 139.5665], 15);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const badge = document.getElementById('courseBadge');
    const locateBtn = document.getElementById('locateBtn');
    const startBtn  = document.getElementById('startBtn');
    const stopBtn   = document.getElementById('stopBtn');
    const followBtn = document.getElementById('followBtn');

    let routePts = [
      [35.7032,139.5608], // 三鷹駅
      [35.7019,139.5630],
      [35.7015,139.5658],
      [35.7012,139.5686],
      [35.7009,139.5705], // 文化園北側
      [35.7006,139.5718],
      [35.7002,139.5732],
      [35.7000,139.5745], // 公園西入口
      [35.6994,139.5740], // 南側
      [35.6996,139.5710],
      [35.6999,139.5680],
      [35.7003,139.5652],
      [35.7007,139.5627],
      [35.7025,139.5609],
      [35.7032,139.5608]  // 三鷹駅
    ];
    let routeLine = L.polyline(routePts, { color:'#2563eb', weight:4 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding:[30,30] });

    map.on('click', (e) => {
      routePts.push([e.latlng.lat, e.latlng.lng]);
      routeLine.setLatLngs(routePts);
    });

    let watchId = null, follow=false, dot=null, accuracyCircle=null;
    let traced=[], tracedLine=null, recording=false;

    function setBadge(state, text) {
      badge.className = 'badge ' + (state||'');
      badge.textContent = text;
    }

    function distToRouteMeters(lat, lng) {
      const p = turf.point([lng, lat]);
      const line = turf.lineString(routePts.map(([la,ln]) => [ln, la]));
      return turf.pointToLineDistance(p, line, { units:'meters' });
    }

    function updateCourseStatus(latlng) {
      const d = distToRouteMeters(latlng.lat, latlng.lng);
      if (d <= 30) setBadge('ok', `ON COURSE（~${Math.round(d)}m）`);
      else if (d <= 60) setBadge('warn', `注意：${Math.round(d)}m外`);
      else setBadge('off', `ルート外：${Math.round(d)}m`);
    }

    function onPos(pos) {
      const { latitude:lat, longitude:lng, accuracy:acc } = pos.coords;
      const latlng = L.latLng(lat,lng);
      if (!dot) {
        dot = L.circleMarker(latlng,{radius:6,weight:2,color:'#2563eb',fillColor:'#3b82f6',fillOpacity:1}).addTo(map);
        accuracyCircle = L.circle(latlng,{radius:acc,color:'#93c5fd',weight:1,fillColor:'#bfdbfe',fillOpacity:0.25}).addTo(map);
      } else {
        dot.setLatLng(latlng);
        accuracyCircle.setLatLng(latlng).setRadius(acc);
      }
      if (follow) map.panTo(latlng,{animate:true});
      if (acc<=50) {
        const prev = traced[traced.length-1];
        const moved = !prev || latlng.distanceTo(L.latLng(prev[0],prev[1]))>=5;
        if (moved && recording) {
          traced.push([lat,lng]);
          if (tracedLine) tracedLine.setLatLngs(traced);
          else tracedLine=L.polyline(traced,{color:'#ef4444',weight:5}).addTo(map);
        }
      }
      updateCourseStatus(latlng);
    }

    locateBtn.onclick=()=>{
      if (!('geolocation' in navigator)) { alert('端末で位置情報不可'); return; }
      follow=true; followBtn.textContent='🔁 追従 ON';
      if (watchId) navigator.geolocation.clearWatch(watchId);
      watchId=navigator.geolocation.watchPosition(onPos,()=>alert('位置情報エラー'),{enableHighAccuracy:true,timeout:10000,maximumAge:3000});
    };
    startBtn.onclick=()=>{ recording=true; traced=[]; if(tracedLine){map.removeLayer(tracedLine);tracedLine=null;} setBadge('warn','記録中'); };
    stopBtn.onclick=()=>{ recording=false; setBadge('','記録停止'); };
    followBtn.onclick=()=>{ follow=!follow; followBtn.textContent= follow?'🔁 追従 ON':'🔁 追従 OFF'; };
    map.on('dragstart',()=>{ if(follow){follow=false; followBtn.textContent='🔁 追従 OFF';} });
    setBadge('','サンプルルート読み込み済み：開始でログ記録／📍で現在地追従');
  </script>
</body>
</html>
