<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Route MVP â€“ å®Ÿèµ°ãƒ­ã‚°ä¿å­˜ï¼ˆIndexedDB+Fallbackï¼‰</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<style>
  :root { --bg:#fff; --fg:#111827; --muted:#6b7280; --accent:#111827; --ok:#065f46; --okbg:#d1fae5; --warn:#92400e; --warnbg:#fef3c7; --off:#991b1b; --offbg:#fee2e2; }
  html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP"; }
  #app { height:100%; display:flex; flex-direction:column; }
  header { padding:10px 12px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  header .tabs { display:flex; gap:8px; }
  .tab { padding:8px 12px; border-radius:999px; border:1px solid #e5e7eb; cursor:pointer; background:#fff; }
  .tab.active { background:#111827; color:#fff; border-color:#111827; }
  main { flex:1; display:flex; }
  #home, #run { flex:1; display:none; }
  #home.active, #run.active { display:flex; }
  #home { flex-direction:column; }
  .list { padding:12px; display:flex; flex-direction:column; gap:10px; overflow:auto; }
  .card { border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:12px; background:#fff; }
  .card.highlight { outline:3px solid #93c5fd; }
  .meta { font-size:12px; color:var(--muted); }
  .btn { border:none; border-radius:10px; padding:8px 10px; font-size:14px; cursor:pointer; }
  .btn.primary { background:#111827; color:#fff; }
  .btn.ghost { background:#fff; color:#111827; border:1px solid #e5e7eb; }
  .btn.danger { background:#ef4444; color:#fff; }
  #run { position:relative; }
  #map { position:absolute; inset:0; }
  .badgewrap { position:fixed; left:8px; right:8px; top:env(safe-area-inset-top,8px); display:flex; gap:8px; z-index:1000; }
  .badge { padding:6px 10px; border-radius:999px; font-weight:600; background:#e2e8f0; }
  .badge.ok{background:var(--okbg); color:var(--ok);}
  .badge.warn{background:var(--warnbg); color:var(--warn);}
  .badge.off{background:var(--offbg); color:var(--off);}
  .dock { position:fixed; right:8px; bottom:8px; display:flex; flex-direction:column; gap:8px; z-index:1000; }
  .btn.big { padding:12px 14px; font-weight:700; }
  .btn.stop { background:#ef4444; color:#fff; }
  .toolbar { position:fixed; left:8px; bottom:8px; z-index:1000; display:flex; gap:8px; }
  .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; z-index:1100; display:none; }
  .hint { position:fixed; left:8px; bottom:60px; background:#ffffffd8; padding:6px 10px; border-radius:10px; font-size:12px; z-index:999; }
</style>
</head>
<body>
<div id="app">
  <header>
    <div style="font-weight:700">Route MVP</div>
    <div class="tabs">
      <button class="tab active" id="tabRoutes">ãƒ«ãƒ¼ãƒˆ</button>
      <button class="tab" id="tabLogs">å®Ÿèµ°ãƒ­ã‚°</button>
    </div>
    <div>
      <button id="btnGoRun" class="btn ghost" onclick="window.showRun && showRun()">ã™ãå®Ÿèµ°ç”»é¢ã¸</button>
    </div>
  </header>

  <!-- èµ·å‹•ç¢ºèªãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒŠãƒ¼ -->
  <div id="bootBanner" style="display:none;padding:8px 12px;background:#e0f2fe;color:#075985;border-bottom:1px solid #7dd3fc;">
    èµ·å‹•OKï¼ˆã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²æ¸ˆã¿ï¼‰
  </div>
  <div id="errBanner" style="display:none;padding:8px 12px;background:#fff7ed;color:#92400e;border-bottom:1px solid #fde68a;">
    IndexedDBãŒä½¿ãˆã¾ã›ã‚“ã€‚localStorageã«ä¿å­˜ã—ã¾ã™ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚ºã‚’OFFã«ã™ã‚‹ã¨æ”¹å–„ã—ã¾ã™ï¼‰ã€‚
  </div>
  <div id="pageErr" style="display:none;padding:8px 12px;background:#fee2e2;color:#991b1b;border-bottom:1px solid #fecaca;">
    ãƒšãƒ¼ã‚¸å†…ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ä¸‹éƒ¨ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
  </div>
  <pre id="pageErrLog" style="display:none;margin:8px 12px;border:1px solid #e5e7eb;background:#f9fafb;padding:8px;border-radius:8px;max-height:180px;overflow:auto;"></pre>

  <main>
    <section id="home" class="active" aria-label="home">
      <div id="routesList" class="list" hidden></div>
      <div id="logsList" class="list" hidden></div>
    </section>
    <section id="run" aria-label="run">
      <div id="map"></div>
      <div class="badgewrap"><div id="courseBadge" class="badge">æº–å‚™ä¸­â€¦</div></div>
      <div class="dock">
        <button id="startBtn" class="btn primary big">â–¶ è¨˜éŒ²é–‹å§‹</button>
        <button id="stopBtn" class="btn stop big">â–  åœæ­¢</button>
        <button id="followBtn" class="btn ghost">ğŸ” è¿½å¾“ ON</button>
        <button id="locateBtn" class="btn ghost">ğŸ“ ç¾åœ¨åœ°ã ã‘</button>
        <button id="backHomeBtn" class="btn ghost">ğŸ  ãƒ›ãƒ¼ãƒ ã¸</button>
      </div>
      <div class="toolbar"><button id="editToggleBtn" class="btn ghost">âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button></div>
      <div class="hint">â–¶ã§GPS+è¨˜éŒ²+è¿½å¾“ONã€‚â– åœæ­¢ã§ä¿å­˜ç¢ºèªâ†’ä¿å­˜å¾Œã¯ãƒ›ãƒ¼ãƒ ï¼ˆå®Ÿèµ°ãƒ­ã‚°ï¼‰ã¸ã€‚</div>
      <div id="toast" class="toast"></div>
    </section>
  </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
<script>
// --- ç”»é¢ã«ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™ ---
(function(){
  const show=(msg)=>{const b=document.getElementById('pageErr');const p=document.getElementById('pageErrLog');
    if(b) b.style.display='block'; if(p){ p.style.display='block'; p.textContent += msg + "\n"; }};
  window.addEventListener('error', (e)=>{ show(`[error] ${e.message||'unknown'} @ ${e.filename||''}:${e.lineno||''}`); });
  window.addEventListener('unhandledrejection', (e)=>{const r=e.reason; show(`[unhandled] ${r&&r.message?r.message:r}`); });
})();
</script>
<script>
/* =========================
   0) ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
========================= */
const fmtDate = (d)=> new Date(d).toLocaleString();
const pad = (n)=> String(n).padStart(2,'0');
function ymd() { const t=new Date(); return `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`; }
function showToast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',2000); }
const m2deg = (m)=> m/111320;

/* ãƒãƒªãƒ©ã‚¤ãƒ³ç¬¦å·åŒ–/å¾©å· */
function encodePolyline(latlngs){
  let lastLat=0,lastLng=0, res='';
  for(const [lat,lng] of latlngs){
    let iLat=Math.round(lat*1e5), iLng=Math.round(lng*1e5);
    let dLat=iLat-lastLat, dLng=iLng-lastLng;
    for(let v of [dLat,dLng]){
      v = v<0 ? ~(v<<1) : v<<1;
      while(v>=0x20){ res += String.fromCharCode((0x20 | (v & 0x1f))+63); v >>= 5; }
      res += String.fromCharCode(v+63);
    }
    lastLat=iLat; lastLng=iLng;
  }
  return res;
}
function decodePolyline(str){
  let idx=0, lat=0, lng=0, coords=[];
  while(idx<str.length){
    let b,shift=0,result=0;
    do{ b=str.charCodeAt(idx++)-63; result |= (b & 0x1f) << shift; shift += 5; }while(b>=0x20);
    let dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
    shift=0; result=0;
    do{ b=str.charCodeAt(idx++)-63; result |= (b & 0x1f) << shift; shift += 5; }while(b>=0x20);
    let dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
    lat += dlat; lng += dlng;
    coords.push([lat/1e5, lng/1e5]);
  }
  return coords;
}

/* å¹³æ»‘åŒ–/é‡è¤‡é™¤å»/è·é›¢ãƒªã‚µãƒ³ãƒ—ãƒ« */
function movingAverage(latlngs){
  if(latlngs.length<3) return latlngs.slice();
  const out = latlngs.map(p=>p.slice());
  for(let i=1;i<latlngs.length-1;i++){
    out[i][0] = (latlngs[i-1][0]+latlngs[i][0]+latlngs[i+1][0])/3;
    out[i][1] = (latlngs[i-1][1]+latlngs[i][1]+latlngs[i+1][1])/3;
  }
  return out;
}
function dedupeTinyMoves(latlngs){
  if(latlngs.length<2) return latlngs.slice();
  const out=[latlngs[0]];
  for(let i=1;i<latlngs.length;i++){
    const a=L.latLng(out[out.length-1][0], out[out.length-1][1]);
    const b=L.latLng(latlngs[i][0], latlngs[i][1]);
    if(a.distanceTo(b)>=2) out.push(latlngs[i]);
  }
  return out;
}
function resampleByDistance(latlngs, stepMeters){
  if(latlngs.length<2) return latlngs.slice();
  const ls = turf.lineString(latlngs.map(([la,ln])=>[ln,la]));
  const lenKm = turf.length(ls, {units:'kilometers'});
  const stepKm = stepMeters/1000;
  const pts=[];
  for(let d=0; d<=lenKm; d+=stepKm){
    const p = turf.along(ls, d, {units:'kilometers'});
    const [lng,lat] = p.geometry.coordinates;
    pts.push([lat,lng]);
  }
  return pts.length?pts:latlngs.slice();
}

/* =========================
   1) ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å±¤ï¼šIndexedDB or localStorage ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
========================= */
let db;
let useLocalFallback = false;

function openDB(){
  return new Promise((resolve)=>{
    if (!('indexedDB' in window)) {
      useLocalFallback = true;
      const b=document.getElementById('errBanner'); if(b) b.style.display='block';
      return resolve(null);
    }
    const req = indexedDB.open('route_mvp', 1);
    req.onupgradeneeded = (e)=>{
      const db = e.target.result;
      if(!db.objectStoreNames.contains('routes')){
        const st = db.createObjectStore('routes', {keyPath:'id'});
        st.createIndex('updatedAt','updatedAt',{unique:false});
      }
      if(!db.objectStoreNames.contains('logs')){
        const st = db.createObjectStore('logs', {keyPath:'id'});
        st.createIndex('endedAt','endedAt',{unique:false});
      }
    };
    req.onsuccess = ()=>{ db=req.result; resolve(db); };
    req.onerror = ()=> {
      useLocalFallback = true;
      const b=document.getElementById('errBanner'); if(b) b.style.display='block';
      resolve(null);
    };
  });
}
// localStorage ãƒ˜ãƒ«ãƒ‘
function lsGet(key, def){ try{ return JSON.parse(localStorage.getItem(key) || def); }catch{ return JSON.parse(def); } }
function lsSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
// IndexedDB tx
function tx(store, mode='readonly'){ return db.transaction(store, mode).objectStore(store); }

// ãƒ«ãƒ¼ãƒˆã¯ä»Šå›ã¯æœªä½¿ç”¨ã€‚logs ã®ã¿ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…
async function dbPut(store, obj){
  if (!useLocalFallback && db){
    return new Promise((res,rej)=>{ const r=tx(store,'readwrite').put(obj); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); });
  } else {
    if (store==='logs'){
      const arr = lsGet('logs','[]');
      const i = arr.findIndex(x=>x.id===obj.id);
      if (i>=0) arr[i]=obj; else arr.unshift(obj);
      lsSet('logs', arr);
      return;
    }
  }
}
async function dbGetAll(store, index=null, desc=true){
  if (!useLocalFallback && db){
    return new Promise((res,rej)=>{
      const st = tx(store);
      const out=[];
      let req = index ? st.index(index).openCursor(null, desc?'prev':'next')
                      : st.openCursor(null, desc?'prev':'next');
      req.onsuccess = (e)=>{ const cur=e.target.result; if(cur){ out.push(cur.value); cur.continue(); } else res(out); };
      req.onerror = ()=>rej(req.error);
    });
  } else {
    if (store==='logs'){
      const arr = lsGet('logs','[]');
      arr.sort((a,b)=> (b.endedAt||'').localeCompare(a.endedAt||''));
      return arr;
    }
    return [];
  }
}
async function dbDelete(store, key){
  if (!useLocalFallback && db){
    return new Promise((res,rej)=>{ const r=tx(store,'readwrite').delete(key); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); });
  } else {
    if (store==='logs'){
      const arr = lsGet('logs','[]').filter(x=>x.id!==key);
      lsSet('logs', arr);
      return;
    }
  }
}


/* =========================
   2) ãƒ›ãƒ¼ãƒ ï¼šä¸€è¦§UI
========================= */
const tabRoutes = document.getElementById('tabRoutes');
const tabLogs   = document.getElementById('tabLogs');
const routesList= document.getElementById('routesList');
const logsList  = document.getElementById('logsList');
const btnGoRun  = document.getElementById('btnGoRun');
let lastSavedLogId = null;

function setHomeTab(which){
  tabRoutes.classList.toggle('active', which==='routes');
  tabLogs.classList.toggle('active', which==='logs');
  routesList.hidden = which!=='routes';
  logsList.hidden   = which!=='logs';
  renderLists(which);
}
async function renderLists(which){
  if(which==='routes'){
    routesList.innerHTML = '';
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `<div><div>ä¸‰é·¹â†”ç‰å·ä¸Šæ°´ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</div><div class="meta">ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ³ãƒ—ãƒ« Â· ç·¨é›†å¯</div></div>
      <div><button class="btn ghost" id="openSample">å®Ÿèµ°ç”»é¢ã§é–‹ã</button></div>`;
    routesList.appendChild(card);
    card.querySelector('#openSample').onclick = ()=>{ showRun(); };
  } else {
    logsList.innerHTML = '';
    const logs = await dbGetAll('logs','endedAt', true);
    if(!logs.length){
      const empty=document.createElement('div');
      empty.className='meta';
      empty.textContent='ä¿å­˜ã•ã‚ŒãŸå®Ÿèµ°ãƒ­ã‚°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚â–¶ã§è¨˜éŒ²ã—ã€åœæ­¢â†’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚';
      logsList.appendChild(empty);
      return;
    }
    for(const log of logs){
      const card = document.createElement('div');
      card.className = 'card' + (log.id===lastSavedLogId ? ' highlight' : '');
      const km = log.distanceMeters ? (log.distanceMeters/1000).toFixed(2) : '-';
      const dur = log.durationSec ? `${Math.floor(log.durationSec/60)}åˆ†` : '-';
      card.innerHTML = `<div>
          <div>${log.name||'å®Ÿèµ°ãƒ­ã‚°'}</div>
          <div class="meta">${fmtDate(log.endedAt)} Â· ${km} km Â· ${dur}</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn ghost" data-open="${log.id}">é–‹ã</button>
          <button class="btn danger" data-del="${log.id}">å‰Šé™¤</button>
        </div>`;
      logsList.appendChild(card);
      if(log.id===lastSavedLogId){ setTimeout(()=>{ card.classList.remove('highlight'); lastSavedLogId=null; }, 2500); }
    }
  }

logsList.querySelectorAll('button[data-open]').forEach(btn=>{
  btn.onclick = async ()=>{
    const id = btn.dataset.open;
    // detail.html ã« id ã‚’æ¸¡ã—ã¦é·ç§»
    location.href = `detail.html?id=${encodeURIComponent(id)}`;
  };
});


    logsList.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.del;
        if(confirm('ã“ã®å®Ÿèµ°ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ await dbDelete('logs', id); renderLists('logs'); }
      };
    });
  }



/* =========================
   3) RUNç”»é¢ï¼ˆåœ°å›³ãƒ»è¨˜éŒ²ï¼‰
========================= */
const home = document.getElementById('home');
const run  = document.getElementById('run');
const backHomeBtn = document.getElementById('backHomeBtn');

function showHome(tab='logs'){
  run.classList.remove('active');
  home.classList.add('active');
  setHomeTab(tab);
}
function showRun(options={}){
  home.classList.remove('active');
  run.classList.add('active');
  initMapOnce();
  if(options.replay){
    drawReplay(options.replay.coords);
  } else {
    resetRunLayers();
  }
}

let map, badge, routePts, routeLine, editMode=false, recording=false, follow=false;
let watchId=null, dot=null, accCircle=null, lastLatLng=null;
let traced=[], tracedLine=null, lastAddTs=0;
const ACC_LIMIT=100, MIN_MOVE=3, MIN_INTERVAL_MS=1000;

function initMapOnce(){
  if(map) return;
  map = L.map('map').setView([35.7015,139.5665], 15);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
  badge = document.getElementById('courseBadge');

  // ã‚µãƒ³ãƒ—ãƒ«é’ãƒ«ãƒ¼ãƒˆ
  routePts = [
    [35.7032,139.5608],[35.7019,139.5630],[35.7015,139.5658],[35.7012,139.5686],
    [35.7009,139.5705],[35.7006,139.5718],[35.7002,139.5732],[35.7000,139.5745],
    [35.6994,139.5740],[35.6996,139.5710],[35.6999,139.5680],[35.7003,139.5652],
    [35.7007,139.5627],[35.7025,139.5609],[35.7032,139.5608]
  ];
  routeLine = L.polyline(routePts, { color:'#2563eb', weight:4 }).addTo(map);
  map.fitBounds(routeLine.getBounds(), { padding:[30,30] });

  // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¯ãƒªãƒƒã‚¯ã§ç‚¹è¿½åŠ ï¼ˆè¨˜éŒ²ä¸­ã¯ä¸å¯ï¼‰
  map.on('click', (e)=>{
    if(!editMode || recording) return;
    routePts.push([e.latlng.lat, e.latlng.lng]);
    routeLine.setLatLngs(routePts);
    if(lastLatLng) updateCourseStatus(lastLatLng);
  });
  map.on('dragstart', ()=>{ if(follow){ follow=false; followBtn.textContent='ğŸ” è¿½å¾“ OFF'; }});
}

/* ãƒãƒƒã‚¸ & ã‚³ãƒ¼ã‚¹åˆ¤å®š */
function setBadge(state,text){ badge.className='badge '+(state||''); badge.textContent=text; }
function distToRouteMeters(lat,lng){
  if(!routePts || routePts.length<2) return null;
  const p = turf.point([lng,lat]);
  const line = turf.lineString(routePts.map(([la,ln])=>[ln,la]));
  return turf.pointToLineDistance(p, line, {units:'meters'});
}
function updateCourseStatus(latlng){
  const d = distToRouteMeters(latlng.lat, latlng.lng);
  if(d==null){ setBadge('', 'ãƒ«ãƒ¼ãƒˆæœªä½œæˆ'); return; }
  if (d<=30) setBadge('ok', `ON COURSEï¼ˆ~${Math.round(d)}mï¼‰`);
  else if (d<=60) setBadge('warn', `æ³¨æ„ï¼š${Math.round(d)}må¤–`);
  else setBadge('off', `ãƒ«ãƒ¼ãƒˆå¤–ï¼š${Math.round(d)}m`);
}

/* ãƒªãƒ—ãƒ¬ã‚¤/ãƒªã‚»ãƒƒãƒˆ */
function resetRunLayers(){
  if(tracedLine){ map.removeLayer(tracedLine); tracedLine=null; }
  traced=[]; lastAddTs=0; recording=false;
  setEditMode(false);
  setBadge('','ã‚µãƒ³ãƒ—ãƒ«ï¼šâœï¸ã§ç·¨é›†ã€â–¶ã§è¨˜éŒ²ã€â– ã§åœæ­¢ä¿å­˜ï¼ğŸ“ã§ç¾åœ¨åœ°è¿½å¾“');
}
function drawReplay(coords){
  resetRunLayers();
  if(tracedLine) map.removeLayer(tracedLine);
  tracedLine = L.polyline(coords, { color:'#ef4444', weight:5 }).addTo(map);
  map.fitBounds(L.latLngBounds(coords), { padding:[30,30] });
  setBadge('','ä¿å­˜æ¸ˆã¿ãƒ­ã‚°ã‚’è¡¨ç¤ºä¸­');
}

/* GPS */
function onPos(pos){
  const { latitude:lat, longitude:lng, accuracy:acc } = pos.coords;
  const latlng = L.latLng(lat,lng);
  lastLatLng = latlng;

  if(!dot){
    dot = L.circleMarker(latlng,{ radius:6, weight:2, color:'#2563eb', fillColor:'#3b82f6', fillOpacity:1 }).addTo(map);
    accCircle = L.circle(latlng,{ radius:acc, color:'#93c5fd', weight:1, fillColor:'#bfdbfe', fillOpacity:0.25 }).addTo(map);
  }else{
    dot.setLatLng(latlng); accCircle.setLatLng(latlng).setRadius(acc);
  }
  if(follow) map.panTo(latlng,{animate:true});

  const now = Date.now();
  if(recording && acc<=ACC_LIMIT && (now-lastAddTs)>=MIN_INTERVAL_MS){
    const prev = traced[traced.length-1];
    const moved = !prev || latlng.distanceTo(L.latLng(prev[0],prev[1]))>=MIN_MOVE;
    if(moved){
      traced.push([lat,lng]); lastAddTs=now;
      if(tracedLine) tracedLine.setLatLngs(traced);
      else tracedLine = L.polyline(traced,{ color:'#ef4444', weight:5 }).addTo(map);
    }
  }
  updateCourseStatus(latlng);
}
function onErr(){ showToast('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼'); if(watchId) navigator.geolocation.clearWatch(watchId), watchId=null; }

/* ãƒœã‚¿ãƒ³ */
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const followBtn= document.getElementById('followBtn');
const locateBtn= document.getElementById('locateBtn');
const editToggleBtn=document.getElementById('editToggleBtn');
// backHomeBtn ã¯ä¸Šã§å–å¾—æ¸ˆã¿

function setEditMode(on){
  editMode = !!on;
  editToggleBtn.textContent = editMode ? 'âœ… ç·¨é›†çµ‚äº†ï¼ˆãƒ­ãƒƒã‚¯ï¼‰' : 'âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
}
startBtn.onclick = ()=>{
  if(!('geolocation' in navigator)){ alert('ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“'); return; }
  follow = true; followBtn.textContent='ğŸ” è¿½å¾“ ON';
  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(onPos, onErr, { enableHighAccuracy:true, maximumAge:0, timeout:20000 });

  setEditMode(false);
  recording = true; traced=[]; lastAddTs=0;
  if(tracedLine){ map.removeLayer(tracedLine); tracedLine=null; }
  window.__logStartedAt = new Date().toISOString();
  setBadge('warn','è¨˜éŒ²ä¸­ï¼šã‚ªãƒ³ã‚³ãƒ¼ã‚¹åˆ¤å®šæœ‰åŠ¹');
  showToast('è¨˜éŒ²ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
};
stopBtn.onclick = async ()=>{
  if(!recording){ showToast('è¨˜éŒ²ã¯é–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
  recording = false;
  const count = traced.length;
  const ok = confirm(`è¨˜éŒ²ã‚’åœæ­¢ã—ã¾ã™ã€‚ãƒ­ã‚°ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒã‚¤ãƒ³ãƒˆæ•°: ${count}ï¼‰`);
  if(!ok){ setBadge('','è¨˜éŒ²åœæ­¢'); showToast('ä¿å­˜ã›ãšçµ‚äº†'); return; }

  const startedAt = window.__logStartedAt || new Date().toISOString();
  const endedAt   = new Date().toISOString();
  let pts = dedupeTinyMoves(traced);
  pts = movingAverage(pts);
  const tolDeg = m2deg(6); // æ¨™æº–ç²¾åº¦ã€‚åˆ‡æ›¿UIã¯ä»Šå¾Œ
  let ls = turf.lineString(pts.map(([la,ln])=>[ln,la]));
  ls = turf.simplify(ls, {tolerance: tolDeg, highQuality: true});
  let simp = ls.geometry.coordinates.map(([lng,lat])=>[lat,lng]);
  simp = resampleByDistance(simp, 5);

  const ls2 = turf.lineString(simp.map(([la,ln])=>[ln,la]));
  const lenMeters = turf.length(ls2,{units:'kilometers'})*1000;
  const bbox = turf.bbox(ls2);
  const polyline = encodePolyline(simp);
  const durationSec = Math.max(1, Math.round((new Date(endedAt)-new Date(startedAt))/1000));

  const id = 'l_'+Math.random().toString(36).slice(2,10);
  const nameDefault = `${ymd()} å®Ÿèµ° 01`;
  const name = prompt('å®Ÿèµ°ãƒ­ã‚°ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', nameDefault) || nameDefault;
  const record = { id, version:1, routeId:null, name, startedAt, endedAt, polyline,
                   pointCount: simp.length, distanceMeters: Math.round(lenMeters),
                   durationSec, bbox };
  await dbPut('logs', record);
  lastSavedLogId = id;

  setBadge('','è¨˜éŒ²åœæ­¢');
  showToast('ä¿å­˜ã—ã¾ã—ãŸ');
  showHome('logs');
};

followBtn.onclick = ()=>{ follow=!follow; followBtn.textContent = follow?'ğŸ” è¿½å¾“ ON':'ğŸ” è¿½å¾“ OFF'; };
locateBtn.onclick = ()=>{
  if(!('geolocation' in navigator)) { alert('ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“'); return; }
  if(watchId) navigator.geolocation.clearWatch(watchId);
  follow = true; followBtn.textContent='ğŸ” è¿½å¾“ ON';
  watchId = navigator.geolocation.watchPosition(onPos, onErr, { enableHighAccuracy:true, maximumAge:0, timeout:20000 });
};
editToggleBtn.onclick = ()=>{ if(recording){ alert('è¨˜éŒ²ä¸­ã¯ç·¨é›†ã§ãã¾ã›ã‚“'); return; } setEditMode(!editMode); };
backHomeBtn.onclick = ()=> showHome('logs');

window.addEventListener('beforeunload', (e)=>{ if(recording){ e.preventDefault(); e.returnValue=''; }});

/* =========================
   4) åˆæœŸè¡¨ç¤ºï¼ˆiOSã§ã‚‚ç¢ºå®Ÿã«èµ·å‹•ï¼‰
========================= */
async function init(){
  document.getElementById('tabRoutes').onclick = ()=> setHomeTab('routes');
  document.getElementById('tabLogs').onclick   = ()=> setHomeTab('logs');
  document.getElementById('btnGoRun').onclick  = ()=> showRun();
  const bb=document.getElementById('bootBanner'); if(bb) bb.style.display='block';
  try{ await openDB(); }catch(e){}
  setHomeTab('logs');
}
document.addEventListener('DOMContentLoaded', init, { once:true });
window.addEventListener('load', ()=>{ if(!window.__booted){ window.__booted=true; init(); }}, { once:true });
</script>
</body>
</html>
