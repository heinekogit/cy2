<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Route MVP â€“ æ”¹ä¿®ç‰ˆï¼ˆç·¨é›†ãƒ­ãƒƒã‚¯ & åœæ­¢ä¿å­˜ & GPSèª¿æ•´ï¼‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    html,body,#map { height:100%; margin:0; }
    .ui { position:fixed; left:8px; right:8px; top:env(safe-area-inset-top,8px); display:flex; gap:8px; z-index:1000; }
    .ui .badge { padding:6px 10px; border-radius:999px; font-weight:600; background:#e2e8f0; }
    .ui .badge.ok{background:#d1fae5;color:#065f46;} .ui .badge.warn{background:#fef3c7;color:#92400e;}
    .ui .badge.off{background:#fee2e2;color:#991b1b;}
    .dock { position:fixed; right:8px; bottom:8px; display:flex; flex-direction:column; gap:8px; z-index:1000; }
    .btn { border:none; border-radius:12px; padding:12px 14px; font-size:14px; }
    .btn.primary{ background:#111827; color:#fff; }
    .btn.ghost{ background:#fff; color:#111827; border:1px solid #e5e7eb; }
    .btn.stop{ background:#ef4444; color:#fff; font-weight:700; }
    .toolbar { position:fixed; left:8px; bottom:8px; z-index:1000; display:flex; gap:8px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="ui">
    <div id="courseBadge" class="badge">æº–å‚™ä¸­â€¦</div>
  </div>

  <div class="dock">
    <button id="locateBtn" class="btn primary">ğŸ“ ç¾åœ¨åœ°</button>
    <button id="startBtn"  class="btn primary">â–¶ è¨˜éŒ²é–‹å§‹</button>
    <button id="stopBtn"   class="btn stop">â–  åœæ­¢</button>
    <button id="followBtn" class="btn ghost">ğŸ” è¿½å¾“ ON</button>
  </div>

  <div class="toolbar">
    <button id="editToggleBtn" class="btn ghost">âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <script>
    // ====== åœ°å›³ ======
    const map = L.map('map').setView([35.7015,139.5665], 15);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);

    // ====== UIå‚ç…§ ======
    const badge = document.getElementById('courseBadge');
    const locateBtn = document.getElementById('locateBtn');
    const startBtn  = document.getElementById('startBtn');
    const stopBtn   = document.getElementById('stopBtn');
    const followBtn = document.getElementById('followBtn');
    const editToggleBtn = document.getElementById('editToggleBtn');

    // ====== äºˆå®šãƒ«ãƒ¼ãƒˆï¼ˆé’ï¼‰: ä¸‰é·¹â†”ç‰å·ä¸Šæ°´ ã–ã£ãã‚Šã‚µãƒ³ãƒ—ãƒ« ======
    let routePts = [
      [35.7032,139.5608],[35.7019,139.5630],[35.7015,139.5658],[35.7012,139.5686],
      [35.7009,139.5705],[35.7006,139.5718],[35.7002,139.5732],[35.7000,139.5745],
      [35.6994,139.5740],[35.6996,139.5710],[35.6999,139.5680],[35.7003,139.5652],
      [35.7007,139.5627],[35.7025,139.5609],[35.7032,139.5608]
    ];
    let routeLine = L.polyline(routePts, { color:'#2563eb', weight:4 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding:[30,30] });

    // ====== ãƒ¢ãƒ¼ãƒ‰åˆ†é›¢ ======
    let editMode = false;   // âœï¸ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹
    let recording = false;  // è¨˜éŒ²ä¸­ã‹
    function setEditMode(on){
      editMode = !!on;
      editToggleBtn.textContent = editMode ? 'âœ… ç·¨é›†çµ‚äº†ï¼ˆãƒ­ãƒƒã‚¯ï¼‰' : 'âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
    }
    setEditMode(false);

    // ã‚¯ãƒªãƒƒã‚¯ã§ç‚¹è¿½åŠ ï¼šç·¨é›†ãƒ¢ãƒ¼ãƒ‰ && éè¨˜éŒ²ä¸­ã®ã¿
    map.on('click', (e) => {
      if (!editMode || recording) return;
      routePts.push([e.latlng.lat, e.latlng.lng]);
      routeLine.setLatLngs(routePts);
      // äºˆå®šãƒ«ãƒ¼ãƒˆæ›´æ–°ã«ä¼´ã„åˆ¤å®šæ›´æ–°
      if (lastLatLng) updateCourseStatus(lastLatLng);
    });

    // è¨˜éŒ²ä¸­ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåœ°å›³æ“ä½œã—ãŸã‚‰è¿½å¾“OFF
    map.on('dragstart', ()=>{ if(follow){ follow=false; followBtn.textContent='ğŸ” è¿½å¾“ OFF'; }});

    // ====== ç¾åœ¨åœ°ãƒ»è¿½å¾“ ======
    let watchId=null, follow=false, dot=null, accuracyCircle=null, lastLatLng=null;
    function setBadge(state, text){ badge.className='badge '+(state||''); badge.textContent=text; }
    function distToRouteMeters(lat, lng){
      if (routePts.length<2) return null;
      const p = turf.point([lng,lat]);
      const line = turf.lineString(routePts.map(([la,ln])=>[ln,la]));
      return turf.pointToLineDistance(p, line, {units:'meters'});
    }
    function updateCourseStatus(latlng){
      const d = distToRouteMeters(latlng.lat, latlng.lng);
      if (d==null){ setBadge('', 'ãƒ«ãƒ¼ãƒˆæœªä½œæˆ'); return; }
      if (d<=30) setBadge('ok', `ON COURSEï¼ˆ~${Math.round(d)}mï¼‰`);
      else if (d<=60) setBadge('warn', `æ³¨æ„ï¼š${Math.round(d)}må¤–`);
      else setBadge('off', `ãƒ«ãƒ¼ãƒˆå¤–ï¼š${Math.round(d)}m`);
    }

    // ====== å®Ÿèµ°ãƒ­ã‚°ï¼ˆèµ¤ï¼‰ ======
    let traced=[], tracedLine=null, lastAddTs=0;
    const ACC_LIMIT=100;        // 100mã¾ã§è¨±å®¹ï¼ˆéƒ½å¸‚éƒ¨å¯¾ç­–ï¼‰
    const MIN_MOVE=3;           // 3mä»¥ä¸Šå‹•ã„ãŸã‚‰æ¡ç”¨
    const MIN_INTERVAL_MS=1000; // 1ç§’é–“éš”ã§å–ã‚Šè¾¼ã¿

    function onPos(pos){
      const { latitude:lat, longitude:lng, accuracy:acc } = pos.coords;
      const latlng = L.latLng(lat,lng);
      lastLatLng = latlng;

      // ç¾åœ¨åœ°æç”»
      if (!dot){
        dot = L.circleMarker(latlng,{ radius:6, weight:2, color:'#2563eb', fillColor:'#3b82f6', fillOpacity:1 }).addTo(map);
        accuracyCircle = L.circle(latlng,{ radius:acc, color:'#93c5fd', weight:1, fillColor:'#bfdbfe', fillOpacity:0.25 }).addTo(map);
      } else {
        dot.setLatLng(latlng);
        accuracyCircle.setLatLng(latlng).setRadius(acc);
      }
      if (follow) map.panTo(latlng,{animate:true});

      // ãƒ­ã‚°å–ã‚Šè¾¼ã¿ï¼šç²¾åº¦ãƒ»ç§»å‹•é‡ãƒ»é–“éš”ã§ãƒ•ã‚£ãƒ«ã‚¿
      const now = Date.now();
      if (recording && acc<=ACC_LIMIT && (now-lastAddTs)>=MIN_INTERVAL_MS){
        const prev = traced[traced.length-1];
        const moved = !prev || latlng.distanceTo(L.latLng(prev[0],prev[1]))>=MIN_MOVE;
        if (moved){
          traced.push([lat,lng]);
          lastAddTs = now;
          if (tracedLine) tracedLine.setLatLngs(traced);
          else tracedLine = L.polyline(traced,{ color:'#ef4444', weight:5 }).addTo(map);
        }
      }

      updateCourseStatus(latlng);
    }

    function onErr(err){
      alert('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼ï¼šæ¨©é™/é›»æ³¢/è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
      if (watchId) navigator.geolocation.clearWatch(watchId), watchId=null;
    }

    // ====== ãƒœã‚¿ãƒ³æŒ™å‹• ======
    locateBtn.onclick = () => {
      if (!('geolocation' in navigator)) { alert('ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“'); return; }
      follow = true; followBtn.textContent='ğŸ” è¿½å¾“ ON';
      if (watchId) navigator.geolocation.clearWatch(watchId);
      watchId = navigator.geolocation.watchPosition(onPos, onErr, {
        enableHighAccuracy:true, maximumAge:0, timeout:20000
      });
    };

    startBtn.onclick = () => {
      recording = true;
      setEditMode(false);                // è¨˜éŒ²ä¸­ã¯å¼·åˆ¶ãƒ­ãƒƒã‚¯
      if (tracedLine) { map.removeLayer(tracedLine); tracedLine=null; }
      traced = []; lastAddTs = 0;
      setBadge('warn','è¨˜éŒ²ä¸­ï¼šã‚ªãƒ³ã‚³ãƒ¼ã‚¹åˆ¤å®šæœ‰åŠ¹');
    };

    stopBtn.onclick = () => {
      if (!recording){ setBadge('','è¨˜éŒ²ã¯é–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
      // åœæ­¢â†’ä¿å­˜ç¢ºèª
      const count = traced.length;
      const confirmSave = confirm(`è¨˜éŒ²ã‚’åœæ­¢ã—ã¾ã™ã€‚ãƒ­ã‚°ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒã‚¤ãƒ³ãƒˆæ•°: ${count}ï¼‰`);
      recording = false;

      if (confirmSave && count>1){
        const today = new Date();
        const y = today.getFullYear(), m=String(today.getMonth()+1).padStart(2,'0'), d=String(today.getDate()).padStart(2,'0');
        // åŒæ—¥é€£ç•ª
        const key = 'logs';
        const logs = JSON.parse(localStorage.getItem(key) || '[]');
        const sameDay = logs.filter(l => (l.startedAt||'').startsWith(`${y}-${m}-${d}`));
        const nameDefault = `${y}-${m}-${d} å®Ÿèµ° ${String(sameDay.length+1).padStart(2,'0')}`;
        const name = prompt('å®Ÿèµ°ãƒ­ã‚°ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', nameDefault) || nameDefault;

        const startedAt = (window.__logStartedAt || new Date()).toISOString();
        const endedAt = new Date().toISOString();
        const routeId = null; // æ—¢å­˜ã®IDç®¡ç†ãŒå…¥ã£ãŸã‚‰å·®ã—æ›¿ãˆ
        const log = { id: 'l_'+Math.random().toString(36).slice(2,10),
                      version:1, routeId, name, startedAt, endedAt,
                      coords: traced, distanceMeters: null, durationSec: null };
        logs.unshift(log);
        localStorage.setItem(key, JSON.stringify(logs));
        alert('ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ä¸€è¦§ã¯å¾Œæ—¥UIã§è¡¨ç¤ºäºˆå®šï¼‰');
      } else {
        alert('ä¿å­˜ã›ãšã«çµ‚äº†ã—ã¾ã—ãŸ');
      }
      setBadge('','è¨˜éŒ²åœæ­¢');
      window.__logStartedAt = null;
    };

    editToggleBtn.onclick = () => {
      if (recording){ alert('è¨˜éŒ²ä¸­ã¯ç·¨é›†ã§ãã¾ã›ã‚“'); return; }
      setEditMode(!editMode);
    };

    followBtn.onclick = () => {
      follow = !follow;
      followBtn.textContent = follow ? 'ğŸ” è¿½å¾“ ON' : 'ğŸ” è¿½å¾“ OFF';
    };

    // è¨˜éŒ²ä¸­ã«é–‰ã˜ã‚‹è­¦å‘Š
    window.addEventListener('beforeunload', (e)=>{
      if (recording){
        e.preventDefault();
        e.returnValue = '';
      }
    });

    setBadge('','ã‚µãƒ³ãƒ—ãƒ«ï¼šâœï¸ã§ç·¨é›†ã€â–¶ã§è¨˜éŒ²ã€â– ã§åœæ­¢ä¿å­˜ï¼ğŸ“ã§ç¾åœ¨åœ°è¿½å¾“');
  </script>
</body>
</html>
