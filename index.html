<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Route MVP – 公開ルート一覧</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --ink:#0f172a;
      --muted:#6b7280;
      --line:#cbd5f5;
      --panel:#ffffff;
      --accent:#1e40af;
      --accent-soft:#e0ecff;
      --shadow:0 8px 30px rgba(15,23,42,0.08);
    }
    *{ box-sizing:border-box; }
    body{
      font-family:"Hiragino Sans","Avenir Next","Yu Gothic","Noto Sans JP",sans-serif;
      color:var(--ink);
      margin:0;
      padding:24px 12px 36px;
      background:
        radial-gradient(1200px 600px at 10% -10%, #f6e6d9 0, transparent 60%),
        radial-gradient(900px 600px at 90% -20%, #dce9ff 0, transparent 55%),
        #f6f7fb;
    }
    .page{
      max-width:880px;
      margin:0 auto;
    }
    .shell{
      background:var(--panel);
      border:2px solid #1f2937;
      border-radius:18px;
      padding:22px 20px 18px;
      box-shadow:var(--shadow);
    }
    header{
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap:12px;
      align-items:center;
    }
    .title{
      font-size:20px;
      font-weight:700;
      letter-spacing:0.2px;
    }
    .account{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-size:14px;
      padding:6px 10px;
      border:1px solid #e2e8f0;
      border-radius:999px;
      color:var(--muted);
      background:#f8fafc;
      min-height:34px;
    }
    .account strong{ color:var(--ink); font-weight:600; }
    .header-actions{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .btn{
      padding:7px 12px;
      border:1px solid #1f2937;
      border-radius:8px;
      background:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      text-decoration:none;
      color:var(--ink);
      font-size:14px;
      font-weight:600;
      transition:transform 0.15s ease, background 0.15s ease;
    }
    .btn:visited{ color:var(--ink); text-decoration:none; }
    .btn:hover{ background:#f1f5f9; transform:translateY(-1px); text-decoration:none; }
    .btn-primary{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
      box-shadow:0 6px 16px rgba(30,64,175,0.25);
    }
    .btn-primary:hover{ background:#1d4ed8; }
    .btn-disabled{
      opacity:0.45;
      pointer-events:none;
    }
    .muted{ color:var(--muted); }
    .actions{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:14px;
      margin:18px 0 10px;
    }
    .action-card{
      border:2px solid #1f2937;
      border-radius:12px;
      padding:18px 14px;
      background:linear-gradient(120deg, #ffffff, #f4f7ff);
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      min-height:92px;
      font-weight:700;
      color:var(--ink);
      text-decoration:none;
      transition:transform 0.18s ease, box-shadow 0.18s ease;
    }
    .action-card small{
      display:block;
      font-weight:600;
      color:#475569;
      margin-top:6px;
      font-size:12px;
      letter-spacing:0.2px;
    }
    .action-card:hover{
      transform:translateY(-2px);
      box-shadow:0 12px 20px rgba(15,23,42,0.12);
    }
    #routesWrap{ margin-top:16px; }
    #filters{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:12px 0 8px;
      font-weight:600;
    }
    #filters label{
      font-weight:600;
      color:var(--muted);
    }
    #routesList .route-card{
      border:2px solid #1f2937;
      border-radius:12px;
      padding:14px 16px;
      margin:10px 0;
      background:#fff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      text-align:left;
      width:100%;
      cursor:pointer;
      transition:background 0.15s ease, transform 0.15s ease;
    }
    #routesList .route-card:hover{ background:#f8fafc; transform:translateY(-1px); }
    .route-title{ font-weight:700; font-size:15px; }
    .route-meta{ font-size:12px; color:var(--muted); margin-top:4px; }
    .badge{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #86a0ff;
      background:var(--accent-soft);
      color:#1e3a8a;
      font-weight:700;
    }
    .badge.prv{ background:#fee2e2; color:#991b1b; border-color:#fecaca; }
    footer{ margin-top:14px; color:var(--muted); }
    @media (max-width: 640px){
      header{ grid-template-columns:1fr; justify-items:start; }
      .header-actions{ width:100%; justify-content:flex-end; }
      .account{ width:100%; justify-content:flex-start; }
      .actions{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      #filters{ flex-direction:column; align-items:flex-start; }
    }
  </style>

  <script src="js/version.js"></script>
  <script>
    // Fallback when version.js is not yet deployed
    if (typeof window.APP_VERSION === 'undefined' || !window.APP_VERSION) {
      window.APP_VERSION = new Date().toISOString().slice(0,10) + '-dev';
    }
  </script>

  <!-- Supabase UMD -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    // Supabase 設定（変数名を厳守）
    const SUPABASE_URL = "https://cqiqhczxuiyakptdjowr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxaXFoY3p4dWl5YWtwdGRqb3dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NzAwNzMsImV4cCI6MjA3MzM0NjA3M30.vCFQoQnsClINKa5tQAz-rNnF5XLEukmn_Nl0Err5k3k";
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:false } });
    window.client = client; // デバッグ用に公開

    // Util
    const V = () => encodeURIComponent(window.APP_VERSION || "");
    const $ = (sel) => document.querySelector(sel);

    const ROUTE_DRAW_PAGE = 'route-edit.html';

    async function getSession() {
      // まずローカルのセッションを取得
      try{
        const { data:{ session } } = await client.auth.getSession();
        if (session?.user) return session;
      }catch(e){ console.warn('getSession(getSession) warn', e); }
      // フォールバックで getUser を呼び、ユーザーだけでも判定
      try{
        const { data:{ user } } = await client.auth.getUser();
        if (user) return { user };
      }catch(e){ console.warn('getSession(getUser) warn', e); }
      return null;
    }

async function getMyAccountId() {
  return AuthCommon.getMyAccountId(client);
}

    // 認証バー
    async function renderAuthBar() {
      try{
        const bar = $("#authBar");
        if (!bar) return;
        const session = await getSession();
        const loginBtn = $("#lnLogin");
        const myBtn = $("#lnMyPage");
        if (!session?.user) {
          bar.innerHTML = `アカウント <strong>未ログイン</strong>`;
          if (loginBtn) {
            loginBtn.textContent = 'ログイン';
            loginBtn.classList.add('btn-primary');
            loginBtn.removeAttribute('data-signout');
            loginBtn.setAttribute('href', `login.html?v=${V()}`);
          }
          if (myBtn) {
            myBtn.classList.add('btn-disabled');
            myBtn.setAttribute('aria-disabled', 'true');
          }
          $("#filters")?.classList.add("muted");
          $("#mineOnlyWrap")?.classList.add("muted");
          const moff = document.getElementById('mineOnly');
          if (moff) moff.disabled = true;
          return;
        } else {
          $("#filters")?.classList.remove("muted");
          $("#mineOnlyWrap")?.classList.remove("muted");
          const mon = document.getElementById('mineOnly');
          if (mon) mon.removeAttribute('disabled');
          const email = session.user.email || "";
          bar.innerHTML = `アカウント <strong>${email}</strong>`;
          if (loginBtn) {
            loginBtn.textContent = 'サインアウト';
            loginBtn.classList.remove('btn-primary');
            loginBtn.setAttribute('data-signout', '1');
            loginBtn.setAttribute('href', `login.html?v=${V()}`);
          }
          if (myBtn) {
            myBtn.classList.remove('btn-disabled');
            myBtn.setAttribute('aria-disabled', 'false');
          }
        }
      }catch(e){
        console.error('renderAuthBar error', e);
        const bar = $("#authBar");
        if(bar) bar.textContent = '認証状態の取得に失敗しました';
      }
    }

    // 公開ルート一覧
    async function loadPublicRoutes(mineOnly=false){
      const box = document.getElementById('routesList');
      if (!box) return;
      try{
        box.textContent = '読み込み中…';

        // セッション/自分のaccount_id
        const { data:{ session } } = await client.auth.getSession();
        const uid = session?.user?.id ?? null;
        let myAccountId = null;
        if (mineOnly && uid){
          const { data: urow, error: e1 } = await client.from('users').select('account_id').eq('id', uid).maybeSingle();
          if (e1) throw e1;
          myAccountId = urow?.account_id ?? null;
          if (!myAccountId){ box.textContent = 'アカウント情報が見つかりません。'; return; }
        }

        let q = client.from('routes')
          .select('id,name,created_at,account_id,is_public')
          .eq('is_public', true)
          .order('created_at', { ascending:false });

        if (mineOnly && myAccountId) q = q.eq('account_id', myAccountId);

        const { data, error } = await q;
        if (error) throw error;
        const routes = data || [];
        if (!routes.length){ box.textContent = '公開ルートがありません。'; return; }

        let html = '';
        for (const r of routes){
          const when = r.created_at ? new Date(r.created_at).toLocaleString() : '-';
          const isPub = r?.is_public === true;
          const badge = isPub ? '<span class="badge pub">公開</span>' : '<span class="badge prv">非公開</span>';
          html += '<button class="route-card" data-id="'+r.id+'">\n'
               +   '<div><div class="route-title">'+(r.name||'(無題ルート)')+' <span class="muted">#'+r.id+'</span></div>'
               +   '<div class="route-meta">'+when+'</div></div>'
               +   '<div>'+badge+'</div>'
               + '</button>';
        }
        box.innerHTML = html;
        box.querySelectorAll('[data-id]').forEach(el=>{
          el.addEventListener('click', ()=>{
            const id = el.getAttribute('data-id');
            location.href = 'detail.html?id='+encodeURIComponent(id)+'&kind=route&v='+V();
          });
        });
      }catch(e){ box.textContent='読み込みに失敗しました: ' + (e && e.message ? e.message : e); console.error('loadPublicRoutes error', e); }
    }

    // 初期化
    async function init() {
      // ヘッダのリンクに現在のバージョンを付与
      try{
        const v = (window.APP_VERSION||'');
        const btnDraw = document.getElementById('btnDrawRoute');
        const lnLogin = document.getElementById('lnLogin');
        const lnMy = document.getElementById('lnMyPage');
        const lnRun = document.getElementById('lnRun');
        if (btnDraw) {
          btnDraw.addEventListener('click', async (ev) => {
            ev.preventDefault();
            const session = await getSession();
            if (session?.user) {
              location.href = `${ROUTE_DRAW_PAGE}?v=${V()}`;
              return;
            }
            const loginUrl = new URL('login.html', window.location.href);
            loginUrl.searchParams.set('returnTo', ROUTE_DRAW_PAGE);
            loginUrl.searchParams.set('v', window.APP_VERSION || '');
            location.href = loginUrl.toString();
          });
        }
        if (lnLogin) lnLogin.href = 'login.html?v=' + encodeURIComponent(v);
        if (lnMy) lnMy.href = 'mypage.html?v=' + encodeURIComponent(v);
        if (lnRun) lnRun.href = 'run.html?v=' + encodeURIComponent(v);
      }catch(e){ console.warn('set header links failed', e); }
      // フィルタ切替
      const mineOnly = $("#mineOnly");
      if (mineOnly) mineOnly.onchange = async ()=> {
        await loadPublicRoutes(mineOnly.checked === true);
      };

      await renderAuthBar();
      await loadPublicRoutes(mineOnly?.checked === true);

      // 認証変化で バー→一覧 をawait順で更新
      client.auth.onAuthStateChange(async (event, session)=>{
        await renderAuthBar();
        await loadPublicRoutes($("#mineOnly")?.checked === true);
        const shouldRedirect = event === 'SIGNED_OUT' || event === 'USER_DELETED';
        if (shouldRedirect) {
          const v = window.APP_VERSION || '';
          location.href = `index.html?v=${v}&t=${Date.now()}`;
        }
      });

      // 履歴復帰（BFCache）時の再描画
      window.addEventListener("pageshow", async ()=>{
        await renderAuthBar();
        await loadPublicRoutes($("#mineOnly")?.checked === true);
      });
    }

    document.addEventListener("DOMContentLoaded", init, { once:true });
    setTimeout(()=>{ try{ const t=document.getElementById('authBar')?.textContent||''; if(t.includes('認証状態を確認中')) renderAuthBar(); }catch(_){} }, 2000);
  </script>

  <!-- ✅ ここから共通化パート -->
<script src="js/auth-common.js"></script>
<script>
  AuthCommon.init(client, { redirectUrl: 'index.html' });
  window.getMyAccountId = () => AuthCommon.getMyAccountId(client);
</script>

</head>
<body>
  <div class="page">
    <div class="shell">
      <header>
        <div class="title">Route MVP</div>
        <div id="authBar" class="account">アカウント <strong>認証状態を確認中</strong></div>
        <div class="header-actions">
          <a id="lnLogin" class="btn" href="login.html">ログイン</a>
          <a id="lnMyPage" class="btn btn-disabled" href="mypage.html" aria-disabled="true">マイページ</a>
        </div>
      </header>

      <section class="actions">
        <button id="btnDrawRoute" class="action-card" type="button">
          ライド
          <small>（モデルルートあり）</small>
          <small>ルートを描く</small>
        </button>
        <a id="lnRun" class="action-card" href="run.html">
          ライド
          <small>（モデルルートあり）</small>
          <small>実走する</small>
        </a>
      </section>

      <section id="routesWrap">
        <div id="filters">
          <span>公開ルート一覧</span>
          <label id="mineOnlyWrap" class="muted">
            <input id="mineOnly" type="checkbox" disabled />
            自分の公開のみ
          </label>
        </div>
        <div id="routesList" class="muted">読み込み中…</div>
      </section>

      <footer>v: <code id="ver"></code></footer>
    </div>
  </div>
  <script>document.getElementById("ver").textContent = window.APP_VERSION;</script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js?v=' + (window.APP_VERSION||''))
        .catch(err => console.error('SW register failed', err));
    }
  </script>
</body>
</html>
