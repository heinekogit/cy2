<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Route MVP – 公開ルート一覧</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto; max-width: 840px; margin: 20px auto; padding: 0 12px; color:#111827; }
    header { display:flex; justify-content:space-between; align-items:center; padding:10px 0; }
    .btn { padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; cursor:pointer; }
    .muted { color:#6b7280; }
    .card { border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; margin:10px 0; background:#fff; display:flex; justify-content:space-between; align-items:center; }
    .badge { padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; }
    .badge.pub { background:#d1fae5; color:#065f46; border-color:#a7f3d0; }
    .badge.prv { background:#fee2e2; color:#991b1b; border-color:#fecaca; }
    #routesWrap { margin-top: 14px; }
    #filters { margin: 8px 0 4px; display:flex; gap:10px; align-items:center; }
    #authForms { display:flex; flex-direction:column; gap:12px; }
    .tabs { display:flex; gap:8px; margin:4px 0 8px; }
    .tab { padding:6px 12px; border:1px solid #d1d5db; border-radius:999px; background:#f9fafb; cursor:pointer; font-size:14px; }
    .tab.active { background:#111827; color:#fff; border-color:#111827; }
    #authForms form { display:flex; flex-direction:column; gap:10px; }
    #authForms input[type="email"], #authForms input[type="password"] { width:100%; padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; }
    #authForms label { font-size:14px; }
    #authForms .actions { display:flex; gap:10px; }
  </style>

  <script src="js/version.js"></script>
  <script>
    // Fallback when version.js is not yet deployed
    if (typeof window.APP_VERSION === 'undefined' || !window.APP_VERSION) {
      window.APP_VERSION = new Date().toISOString().slice(0,10) + '-dev';
    }
  </script>

  <!-- Supabase UMD -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    // Supabase 設定（変数名を厳守）
    const SUPABASE_URL = "https://cqiqhczxuiyakptdjowr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxaXFoY3p4dWl5YWtwdGRqb3dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NzAwNzMsImV4cCI6MjA3MzM0NjA3M30.vCFQoQnsClINKa5tQAz-rNnF5XLEukmn_Nl0Err5k3k";
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:false } });
    window.client = client; // デバッグ用に公開

    // Util
    const V = () => encodeURIComponent(window.APP_VERSION || "");
    const $ = (sel) => document.querySelector(sel);

    async function getSession() {
      // まずローカルのセッションを取得
      try{
        const { data:{ session } } = await client.auth.getSession();
        if (session?.user) return session;
      }catch(e){ console.warn('getSession(getSession) warn', e); }
      // フォールバックで getUser を呼び、ユーザーだけでも判定
      try{
        const { data:{ user } } = await client.auth.getUser();
        if (user) return { user };
      }catch(e){ console.warn('getSession(getUser) warn', e); }
      return null;
    }

    async function getMyAccountId() {
      const session = await getSession();
      if (!session?.user) return null;
      const { data, error } = await client.from("users").select("account_id").eq("id", session.user.id).single();
      if (error) { console.warn("users.account_id error", error); return null; }
      return data?.account_id ?? null;
    }

    function toggleAuthForms(show) {
      const wrap = document.getElementById('authForms');
      if (!wrap) return;
      wrap.hidden = !show;
      if (show) {
        setActiveAuthTab('login');
      }
    }

    function setActiveAuthTab(which='login') {
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const tabLogin = document.getElementById('tabLogin');
      const tabSignup = document.getElementById('tabSignup');
      const isLogin = which === 'login';
      if (loginForm) loginForm.style.display = isLogin ? '' : 'none';
      if (signupForm) signupForm.style.display = isLogin ? 'none' : '';
      tabLogin?.classList.toggle('active', isLogin);
      tabSignup?.classList.toggle('active', !isLogin);
    }

    function resetAuthForms() {
      document.getElementById('loginForm')?.reset();
      document.getElementById('signupForm')?.reset();
      const agree = document.getElementById('signupAgree');
      if (agree) agree.checked = false;
    }

    async function signIn(event) {
      event?.preventDefault();
      try {
        const email = document.querySelector('#loginForm [name="email"]')?.value.trim() || '';
        const password = document.querySelector('#loginForm [name="password"]')?.value || '';
        if (!email || !password) { alert('メール/パスワードを入力してください'); return; }
        const { error } = await client.auth.signInWithPassword({ email, password });
        if (error) { alert('ログインエラー: ' + error.message); return; }
        resetAuthForms();
        toggleAuthForms(false);
        await renderAuthBar();
        await loadPublicRoutes(document.getElementById('mineOnly')?.checked === true);
      } catch(e) {
        console.error('signIn error', e);
        alert('ログイン処理でエラーが発生しました');
      }
    }

    async function signUp(event) {
      event?.preventDefault();
      try {
        const email = document.querySelector('#signupForm [name="email"]')?.value.trim() || '';
        const password = document.querySelector('#signupForm [name="password"]')?.value || '';
        const agree = document.getElementById('signupAgree')?.checked ?? false;
        if (!email || !password) { alert('メール/パスワードを入力してください'); return; }
        if (!agree) { alert('利用規約へ同意してください'); return; }
        const { error } = await client.auth.signUp({ email, password });
        if (error) { alert('登録エラー: ' + error.message); return; }
        alert('登録しました。確認メールを送信しました。メール内のリンクを開いてください。');
        document.getElementById('signupForm')?.reset();
        setActiveAuthTab('login');
        const loginEmail = document.querySelector('#loginForm [name="email"]');
        if (loginEmail) loginEmail.value = email;
      } catch(e) {
        console.error('signUp error', e);
        alert('新規登録処理でエラーが発生しました');
      }
    }

    function setupAuthForms() {
      const tabLogin = document.getElementById('tabLogin');
      const tabSignup = document.getElementById('tabSignup');
      tabLogin?.addEventListener('click', () => setActiveAuthTab('login'));
      tabSignup?.addEventListener('click', () => setActiveAuthTab('signup'));
      document.getElementById('loginForm')?.addEventListener('submit', signIn);
      document.getElementById('signupForm')?.addEventListener('submit', signUp);
      setActiveAuthTab('login');
    }

    // 認証バー
    async function renderAuthBar() {
      try{
        const bar = $("#authBar");
        if (!bar) return;
        const session = await getSession();
        if (!session?.user) {
          bar.innerHTML = `
            未ログインです。
            <a class="btn" href="login.html?v=${V()}">ログインへ</a>
          `;
          resetAuthForms();
          toggleAuthForms(true);
          $("#filters")?.classList.add("muted");
          $("#mineOnlyWrap")?.classList.add("muted");
          const moff = document.getElementById('mineOnly');
          if (moff) moff.disabled = true;
        } else {
          const email = session.user.email || "";
          bar.innerHTML = `
            ログイン中: <strong>${email}</strong>
            <span class="muted" style="margin-left:6px;">ID: ${session.user.id}</span>
            <span style="margin-left:8px;"></span>
            <a class="btn" href="mypage.html?v=${V()}">マイページへ</a>
            <button class="btn" id="btnSignOut" style="margin-left:6px;">Sign out</button>
          `;
          const mon = document.getElementById('mineOnly');
          if (mon) mon.removeAttribute('disabled');
          $("#filters")?.classList.remove("muted");
          $("#mineOnlyWrap")?.classList.remove("muted");
          const btn = $("#btnSignOut");
          if (btn) btn.onclick = async () => {
            await client.auth.signOut();
            await renderAuthBar();
            await loadPublicRoutes($("#mineOnly")?.checked === true);
          };
          toggleAuthForms(false);
        }
      }catch(e){
        console.error('renderAuthBar error', e);
        const bar = $("#authBar");
        if(bar) bar.textContent = '認証状態の取得に失敗しました';
      }
    }

    // 公開ルート一覧
    async function loadPublicRoutes(mineOnly=false){
      const box = document.getElementById('routesList');
      if (!box) return;
      try{
        box.textContent = '読み込み中…';

        // セッション/自分のaccount_id
        const { data:{ session } } = await client.auth.getSession();
        const uid = session?.user?.id ?? null;
        let myAccountId = null;
        if (mineOnly && uid){
          const { data: urow, error: e1 } = await client.from('users').select('account_id').eq('id', uid).maybeSingle();
          if (e1) throw e1;
          myAccountId = urow?.account_id ?? null;
          if (!myAccountId){ box.textContent = 'アカウント情報が見つかりません。'; return; }
        }

        let q = client.from('routes')
          .select('id,name,created_at,account_id,is_public')
          .eq('is_public', true)
          .order('created_at', { ascending:false });

        if (mineOnly && myAccountId) q = q.eq('account_id', myAccountId);

        const { data, error } = await q;
        if (error) throw error;
        const routes = data || [];
        if (!routes.length){ box.textContent = '公開ルートがありません。'; return; }

        let html = '';
        for (const r of routes){
          const when = r.created_at ? new Date(r.created_at).toLocaleString() : '-';
          const isPub = r?.is_public === true;
          const badge = isPub ? '<span class="badge pub">公開</span>' : '<span class="badge prv">非公開</span>';
          html += '<button class="card" style="width:100%;text-align:left;" data-id="'+r.id+'">\n'
               +   '<div><div style="font-weight:600;">'+(r.name||'(無題ルート)')+' <span class="muted">#'+r.id+'</span></div>'
               +   '<div class="muted" style="font-size:12px;">'+when+'</div></div>'
               +   '<div>'+badge+'</div>'
               + '</button>';
        }
        box.innerHTML = html;
        box.querySelectorAll('[data-id]').forEach(el=>{
          el.addEventListener('click', ()=>{
            const id = el.getAttribute('data-id');
            location.href = 'detail.html?id='+encodeURIComponent(id)+'&kind=route&v='+V();
          });
        });
      }catch(e){ box.textContent='読み込みに失敗しました: ' + (e && e.message ? e.message : e); console.error('loadPublicRoutes error', e); }
    }

    // 初期化
    async function init() {
      // ヘッダのリンクに現在のバージョンを付与
      try{
        const v = (window.APP_VERSION||'');
        const lnLogin = document.getElementById('lnLogin');
        const lnMy = document.getElementById('lnMyPage');
        if (lnLogin) lnLogin.href = 'login.html?v=' + encodeURIComponent(v);
        if (lnMy) lnMy.href = 'mypage.html?v=' + encodeURIComponent(v);
      }catch(e){ console.warn('set header links failed', e); }
      // フィルタ切替
      const mineOnly = $("#mineOnly");
      if (mineOnly) mineOnly.onchange = async ()=> {
        await loadPublicRoutes(mineOnly.checked === true);
      };

      setupAuthForms();

      await renderAuthBar();
      await loadPublicRoutes(mineOnly?.checked === true);

      // 認証変化で バー→一覧 をawait順で更新
      client.auth.onAuthStateChange(async ()=>{
        await renderAuthBar();
        await loadPublicRoutes($("#mineOnly")?.checked === true);
      });

      // 履歴復帰（BFCache）時の再描画
      window.addEventListener("pageshow", async ()=>{
        await renderAuthBar();
        await loadPublicRoutes($("#mineOnly")?.checked === true);
      });
    }

    document.addEventListener("DOMContentLoaded", init, { once:true });
    setTimeout(()=>{ try{ const t=document.getElementById('authBar')?.textContent||''; if(t.includes('認証状態を確認中')) renderAuthBar(); }catch(_){} }, 2000);
  </script>
</head>
<body>
  <header>
    <div style="font-weight:700;">Route MVP</div>
    <div>
      <a id="lnLogin" class="btn" href="login.html">ログイン</a>
      <a id="lnMyPage" class="btn" href="mypage.html">マイページ</a>
    </div>
  </header>

  <div id="authBar" class="card">認証状態を確認中…</div>

  <section id="authForms" class="card" hidden>
    <h2 style="font-size:18px; margin:0;">ログイン / 新規登録</h2>
    <div class="tabs">
      <button type="button" id="tabLogin" class="tab active">ログイン</button>
      <button type="button" id="tabSignup" class="tab">新規登録</button>
    </div>

    <form id="loginForm">
      <div>
        <label class="muted" style="display:block;">メールアドレス</label>
        <input type="email" name="email" placeholder="you@example.com" required />
      </div>
      <div>
        <label class="muted" style="display:block;">パスワード</label>
        <input type="password" name="password" placeholder="••••••••" required />
      </div>
      <div class="actions">
        <button class="btn" type="submit">ログイン</button>
      </div>
    </form>

    <form id="signupForm" style="display:none;">
      <div>
        <label class="muted" style="display:block;">メールアドレス</label>
        <input type="email" name="email" placeholder="you@example.com" required />
      </div>
      <div>
        <label class="muted" style="display:block;">パスワード</label>
        <input type="password" name="password" placeholder="••••••••" required />
      </div>
      <div>
        <label><input type="checkbox" id="signupAgree" required /> 利用規約に同意する</label>
      </div>
      <div class="actions">
        <button class="btn" type="submit">新規登録</button>
      </div>
    </form>

    <p class="muted" style="font-size:12px; margin:0;">登録後は確認メールのリンクを開いてください。</p>
  </section>

  <section id="routesWrap">
    <div id="filters">
      <span class="muted">公開ルート一覧</span>
      <label id="mineOnlyWrap" class="muted" style="margin-left:8px;">
        <input id="mineOnly" type="checkbox" disabled />
        自分の公開のみ
      </label>
    </div>
    <div id="routesList" class="muted">読み込み中…</div>
  </section>

  <footer class="muted" style="margin-top:14px;">v: <code id="ver"></code></footer>
  <script>document.getElementById("ver").textContent = window.APP_VERSION;</script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js?v=' + (window.APP_VERSION||''))
        .catch(err => console.error('SW register failed', err));
    }
  </script>
</body>
</html>
