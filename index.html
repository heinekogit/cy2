<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Route MVP â€“ Supabase ç‰ˆ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script>window.__APP_VERSION__='2025-09-14-03';</script>
  <style>
    :root { --bg:#fff; --fg:#111827; --muted:#6b7280; --accent:#111827; --ok:#065f46; --okbg:#d1fae5; --warn:#92400e; --warnbg:#fef3c7; --off:#991b1b; --offbg:#fee2e2; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP"; }
    #app { height:100%; display:flex; flex-direction:column; }
    header { padding:10px 12px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    header .tabs { display:flex; gap:8px; }
    .tab { padding:8px 12px; border-radius:999px; border:1px solid #e5e7eb; cursor:pointer; background:#fff; }
    .tab.active { background:#111827; color:#fff; border-color:#111827; }
    main { flex:1; display:flex; }
    #home, #run { flex:1; display:none; }
    #home.active, #run.active { display:flex; }
    #home { flex-direction:column; }
    .list { padding:12px; display:flex; flex-direction:column; gap:10px; overflow:auto; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:12px; background:#fff; }
    .card.highlight { outline:3px solid #93c5fd; }
    .meta { font-size:12px; color:var(--muted); }
    .btn { border:none; border-radius:10px; padding:8px 10px; font-size:14px; cursor:pointer; }
    .btn.primary { background:#111827; color:#fff; }
    .btn.ghost { background:#fff; color:#111827; border:1px solid #e5e7eb; }
    .btn.danger { background:#ef4444; color:#fff; }
    #run { position:relative; }
    #map { position:absolute; inset:0; }
    .badgewrap { position:fixed; left:8px; right:8px; top:env(safe-area-inset-top,8px); display:flex; gap:8px; z-index:1000; }
    .badge { padding:6px 10px; border-radius:999px; font-weight:600; background:#e2e8f0; }
    .badge.ok{background:var(--okbg); color:var(--ok);}
    .badge.warn{background:var(--warnbg); color:var(--warn);}
    .badge.off{background:var(--offbg); color:var(--off);}
    .dock { position:fixed; right:8px; bottom:8px; display:flex; flex-direction:column; gap:8px; z-index:1000; }
    .btn.big { padding:12px 14px; font-weight:700; }
    .btn.stop { background:#ef4444; color:#fff; }
    .toolbar { position:fixed; left:8px; bottom:8px; z-index:1000; display:flex; gap:8px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; z-index:1100; display:none; }
    .hint { position:fixed; left:8px; bottom:60px; background:#ffffffd8; padding:6px 10px; border-radius:10px; font-size:12px; z-index:999; }
    footer { padding:6px 10px; font-size:12px; color:#6b7280; border-top:1px solid #e5e7eb; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div style="font-weight:700">Route MVP</div>
    <div class="tabs">
      <button class="tab active" id="tabRoutes">ãƒ«ãƒ¼ãƒˆ</button>
      <button class="tab" id="tabLogs">å®Ÿèµ°ãƒ­ã‚°</button>
    </div>
    <div>
      <button id="btnGoRun" class="btn ghost">ã™ãå®Ÿèµ°ç”»é¢ã¸</button>
    </div>
  </header>

  <!-- èªè¨¼ãƒãƒ¼ -->
  <div id="authBar" style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;margin:10px 0;">
    èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­â€¦
  </div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³è€…ãƒ«ãƒ¼ãƒˆä¸€è¦§ï¼ˆroutesï¼‰ -->
  <section style="margin-top:12px;">
    <h2 style="font-size:18px;margin:6px 0;">ã‚ãªãŸã®ãƒ«ãƒ¼ãƒˆ</h2>
    <div id="routesList">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  </section>

  <main>
    <section id="home" class="active" aria-label="home">
      <!-- â˜…é‡è¤‡IDã‚’æ’é™¤ï¼šã“ã“ã¯ logsList ã®ã¿ -->
      <div id="logsList" class="list" hidden></div>
    </section>

    <section id="run" aria-label="run">
      <div id="map"></div>
      <div class="badgewrap"><div id="courseBadge" class="badge">æº–å‚™ä¸­â€¦</div></div>
      <div class="dock">
        <button id="startBtn" class="btn primary big">â–¶ è¨˜éŒ²é–‹å§‹</button>
        <button id="stopBtn" class="btn stop big">â–  åœæ­¢</button>
        <button id="followBtn" class="btn ghost">ğŸ” è¿½å¾“ OFF</button>
        <button id="locateBtn" class="btn ghost">ğŸ“ ç¾åœ¨åœ°ã ã‘</button>
        <button id="backHomeBtn" class="btn ghost">ğŸ  ãƒ›ãƒ¼ãƒ ã¸</button>
      </div>
      <div class="toolbar"><button id="editToggleBtn" class="btn ghost">âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button></div>
      <div class="hint">â–¶ã§GPS+è¨˜éŒ²+è¿½å¾“ONã€‚â– åœæ­¢ã§ä¿å­˜ç¢ºèªâ†’ä¿å­˜å¾Œã¯ãƒ›ãƒ¼ãƒ ï¼ˆå®Ÿèµ°ãƒ­ã‚°ï¼‰ã¸ã€‚</div>
      <div id="toast" class="toast"></div>
    </section>
  </main>

  <footer>v: <script>document.write(window.__APP_VERSION__)</script></footer>
</div>

<!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

<!-- 1) Supabase åˆæœŸåŒ–ï¼ˆlogin_inline_client ã¨åŒä¸€ã®URL/ANONã«çµ±ä¸€ï¼‰ -->
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
  const SUPABASE_URL = 'https://cqiqhczxuiyakptdjowr.supabase.co';  /* â† ã‚ãªãŸã®URLï¼ˆæ—¢å­˜ã¨åŒã˜ï¼‰ */
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxaXFoY3p4dWl5YWtwdGRqb3dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NzAwNzMsImV4cCI6MjA3MzM0NjA3M30.vCFQoQnsClINKa5tQAz-rNnF5XLEukmn_Nl0Err5k3k'; /* â† ã‚ãªãŸã®anon keyï¼ˆæ—¢å­˜ã¨åŒã˜ï¼‰ */
  window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  console.log('[INIT] supabase ok');

  /* ================= èªè¨¼ãƒãƒ¼ ================= */
  async function __getSession(){ const { data:{ session } } = await supabase.auth.getSession(); return session; }

  async function renderAuthBar(){
    const el = document.getElementById('authBar');
    if (!el) return;
    const session = await __getSession();
    if (!session?.user) {
      el.innerHTML = `æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚
        <a href="login_inline_client.html" style="margin-left:8px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;display:inline-block;">ãƒ­ã‚°ã‚¤ãƒ³ã¸</a>`;
    } else {
      const u = session.user;
      el.innerHTML = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <code>${u.email ?? ''}</code><br/>
        <small>ID: ${u.id}</small>
        <div style="margin-top:6px">
          <button id="signOutBtn" style="padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;">Sign out</button>
        </div>`;
      document.getElementById('signOutBtn').onclick = async () => {
        await supabase.auth.signOut();
        await renderAuthBar();
        await loadRoutesForCurrentUser(); // ä¸€è¦§ã‚‚æ›´æ–°
      };
    }
  }

  /* ============ è‡ªåˆ†ã®ãƒ«ãƒ¼ãƒˆä¸€è¦§ï¼ˆprivate + publicï¼‰ ============ */
  async function getMyAccountId() {
    const session = await __getSession();
    if (!session?.user) return null;
    const { data, error } = await supabase.from('users').select('account_id').eq('id', session.user.id).single();
    if (error) { console.error(error); return null; }
    return data?.account_id ?? null;
  }

  async function loadRoutesForCurrentUser() {
    const box = document.getElementById('routesList');
    if (!box) return;

    const acc = await getMyAccountId();
    if (!acc) { box.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³ã®ãŸã‚è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚'; return; }

    const { data, error } = await supabase.from('routes')
      .select('id, name, visibility, created_at')
      .or(`owner_account_id.eq.${acc},visibility.eq.public`)
      .order('created_at', { ascending:false })
      .limit(50);

    if (error) { console.error(error); box.textContent='èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'; return; }
    if (!data || data.length === 0) { box.textContent='ãƒ«ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚'; return; }

    box.innerHTML = data.map(r=>{
      const when = new Date(r.created_at).toLocaleString();
      const vis = r.visibility === 'public' ? 'å…¬é–‹' : 'éå…¬é–‹';
      return `<div style="border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin:8px 0;">
        <div style="font-weight:600;">${r.name ?? '(ç„¡é¡Œãƒ«ãƒ¼ãƒˆ)'} <span style="color:#6b7280;font-weight:400;">#${r.id}</span></div>
        <div style="color:#6b7280;font-size:12px;">${when}ãƒ»${vis}</div>
        <div style="margin-top:6px;">
          <a href="detail.html?id=${r.id}" style="padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;display:inline-block;">è©³ç´°</a>
        </div>
      </div>`;
    }).join('');
  }

  // åˆæœŸè¡¨ç¤ºï¼‹èªè¨¼çŠ¶æ…‹å¤‰åŒ–ã§æ›´æ–°
  await renderAuthBar();
  await loadRoutesForCurrentUser();
  supabase.auth.onAuthStateChange(async ()=>{ await renderAuthBar(); await loadRoutesForCurrentUser(); });
</script>

<!-- 2) Supabaseç‰ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆwindow.db* ã‚’å…¬é–‹ï¼‰ -->
<script type="module" src="js/storage.js?v=20250914-03"></script>

<!-- 3) ã‚¢ãƒ—ãƒªæœ¬ä½“ï¼ˆUIãƒ»åœ°å›³ãƒ»è¨˜éŒ²ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ -->
<script>
/* ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
const fmtDate = (d)=> new Date(d).toLocaleString();
const pad = (n)=> String(n).padStart(2,'0');
function ymd() { const t=new Date(); return `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`; }
function showToast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',2000); }
const m2deg = (m)=> m/111320;

/* polyline encode/decodeï¼ˆç°¡æ˜“ try/catch è¿½åŠ ï¼‰ */
function encodePolyline(latlngs){
  try{
    let lastLat=0,lastLng=0, res='';
    for(const [lat,lng] of latlngs){
      let iLat=Math.round(lat*1e5), iLng=Math.round(lng*1e5);
      let dLat=iLat-lastLat, dLng=iLng-lastLng;
      for(let v of [dLat,dLng]){
        v = v<0 ? ~(v<<1) : v<<1;
        while(v>=0x20){ res += String.fromCharCode((0x20 | (v & 0x1f))+63); v >>= 5; }
        res += String.fromCharCode(v+63);
      }
      lastLat=iLat; lastLng=iLng;
    }
    return res;
  }catch(e){ console.error('encodePolyline error', e); return ''; }
}
function decodePolyline(str){
  try{
    let idx=0, lat=0, lng=0, coords=[];
    while(idx<str.length){
      let b,shift=0,result=0;
      do{ b=str.charCodeAt(idx++)-63; result |= (b & 0x1f) << shift; shift += 5; }while(b>=0x20);
      let dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
      shift=0; result=0;
      do{ b=str.charCodeAt(idx++)-63; result |= (b & 0x1f) << shift; shift += 5; }while(b>=0x20);
      let dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
      lat += dlat; lng += dlng;
      coords.push([lat/1e5, lng/1e5]);
    }
    return coords;
  }catch(e){ console.error('decodePolyline error', e); return []; }
}

/* å¹³æ»‘åŒ–/é‡è¤‡é™¤å»/è·é›¢ãƒªã‚µãƒ³ãƒ—ãƒ« */
function movingAverage(latlngs){
  if(latlngs.length<3) return latlngs.slice();
  const out = latlngs.map(p=>p.slice());
  for(let i=1;i<latlngs.length-1;i++){
    out[i][0] = (latlngs[i-1][0]+latlngs[i][0]+latlngs[i+1][0])/3;
    out[i][1] = (latlngs[i-1][1]+latlngs[i][1]+latlngs[i+1][1])/3;
  }
  return out;
}
function dedupeTinyMoves(latlngs){
  if(latlngs.length<2) return latlngs.slice();
  const out=[latlngs[0]];
  for(let i=1;i<latlngs.length;i++){
    const a=L.latLng(out[out.length-1][0], out[out.length-1][1]);
    const b=L.latLng(latlngs[i][0], latlngs[i][1]);
    if(a.distanceTo(b)>=2) out.push(latlngs[i]);
  }
  return out;
}
function resampleByDistance(latlngs, stepMeters){
  if(latlngs.length<2) return latlngs.slice();
  const ls = turf.lineString(latlngs.map(([la,ln])=>[ln,la]));
  const lenKm = turf.length(ls, {units:'kilometers'});
  const stepKm = stepMeters/1000;
  const pts=[];
  for(let d=0; d<=lenKm; d+=stepKm){
    const p = turf.along(ls, d, {units:'kilometers'});
    const [lng,lat] = p.geometry.coordinates;
    pts.push([lat,lng]);
  }
  return pts.length?pts:latlngs.slice();
}

/* ========= ä¸€è¦§UIï¼ˆSupabaseã®dbGetAllã‚’ä½¿ç”¨ï¼‰ ========= */
const tabRoutes = document.getElementById('tabRoutes');
const tabLogs   = document.getElementById('tabLogs');
const routesList= document.getElementById('routesList');
const logsList  = document.getElementById('logsList');
const btnGoRun  = document.getElementById('btnGoRun');
let lastSavedLogId = null;

function setHomeTab(which){
  tabRoutes.classList.toggle('active', which==='routes');
  tabLogs.classList.toggle('active', which==='logs');
  routesList.hidden = which!=='routes';
  logsList.hidden   = which!=='logs';
  renderLists(which);
}
async function renderLists(which){
  if(which==='routes'){
    routesList.innerHTML = '';
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `<div><div>ä¸‰é·¹â†”ç‰å·ä¸Šæ°´ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</div><div class="meta">ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ³ãƒ—ãƒ« Â· ç·¨é›†å¯</div></div>
      <div><button class="btn ghost" id="openSample">å®Ÿèµ°ç”»é¢ã§é–‹ã</button></div>`;
    routesList.appendChild(card);
    card.querySelector('#openSample').onclick = ()=>{ showRun(); };
  } else {
    logsList.innerHTML = '';
    const logs = await window.dbGetAll('logs');  // Supabaseç‰ˆ
    if(!logs.length){
      const empty=document.createElement('div');
      empty.className='meta';
      empty.textContent='ä¿å­˜ã•ã‚ŒãŸå®Ÿèµ°ãƒ­ã‚°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚â–¶ã§è¨˜éŒ²ã—ã€åœæ­¢â†’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚';
      logsList.appendChild(empty);
      return;
    }
    for(const log of logs){
      const card = document.createElement('div');
      card.className = 'card' + (log.id===lastSavedLogId ? ' highlight' : '');
      const km = log.distanceMeters ? (log.distanceMeters/1000).toFixed(2) : (log.distance_m ? (Number(log.distance_m)/1000).toFixed(2) : '-');
      const durSec = log.durationSec ?? log.duration_s;
      const dur = durSec ? `${Math.floor(durSec/60)}åˆ†` : '-';
      const ended = log.endedAt ?? log.ended_at;
      card.innerHTML = `<div>
          <div>${log.name||'å®Ÿèµ°ãƒ­ã‚°'}</div>
          <div class="meta">${ended ? new Date(ended).toLocaleString() : 'â€”'} Â· ${km} km Â· ${dur}</div>
        </div>
        <div style="display:flex; gap:8px;">
          <a href="detail.html?src=routes&id=${log.id}">é–‹ã</a>
          <button class="btn danger" data-del="${log.id}">å‰Šé™¤</button>
        </div>`;
      logsList.appendChild(card);
      if(log.id===lastSavedLogId){ setTimeout(()=>{ card.classList.remove('highlight'); lastSavedLogId=null; }, 2500); }
    }
  }

  logsList.querySelectorAll('button[data-open]').forEach(btn=>{
    btn.onclick = ()=>{ const id = btn.dataset.open; location.href = `detail.html?id=${encodeURIComponent(id)}`; };
  });
  logsList.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = Number(btn.dataset.del);
      if(confirm('ã“ã®å®Ÿèµ°ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
        await window.dbDelete('logs', id);
        renderLists('logs');
      }
    };
  });
}

/* ========= RUNç”»é¢ï¼ˆåœ°å›³ãƒ»è¨˜éŒ²ï¼‰ ========= */
const home = document.getElementById('home');
const run  = document.getElementById('run');
const backHomeBtn = document.getElementById('backHomeBtn');

function clearWatchIfAny(){
  if(window.watchId){
    navigator.geolocation.clearWatch(window.watchId);
    window.watchId = null;
  }
}

function showHome(tab='logs'){
  run.classList.remove('active');
  home.classList.add('active');
  clearWatchIfAny();                         // â˜… ãƒ›ãƒ¼ãƒ æˆ»ã‚Šã§GPSè§£é™¤
  window.__logStartedAt = null;              // â˜… é–‹å§‹æ™‚åˆ»ã‚‚ã‚¯ãƒªã‚¢
  setHomeTab(tab);
}
function showRun(options={}){
  home.classList.remove('active');
  run.classList.add('active');
  initMapOnce();
  if(options.replay){ drawReplay(options.replay.coords); } else { resetRunLayers(); }
}
window.showRun = showRun; // â˜… å¿…è¦ãªã‚‰ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç­‰ã‹ã‚‰å‘¼ã¹ã‚‹

let map, badge, routePts, routeLine, editMode=false, recording=false, follow=false;
window.watchId = null;
let dot=null, accCircle=null, lastLatLng=null;
let traced=[], tracedLine=null, lastAddTs=0;
const ACC_LIMIT=100, MIN_MOVE=3, MIN_INTERVAL_MS=1000;

function initMapOnce(){
  if(map) return;
  map = L.map('map').setView([35.7015,139.5665], 15);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
  badge = document.getElementById('courseBadge');
  // ã‚µãƒ³ãƒ—ãƒ«é’ãƒ«ãƒ¼ãƒˆ
  routePts = [
    [35.7032,139.5608],[35.7019,139.5630],[35.7015,139.5658],[35.7012,139.5686],
    [35.7009,139.5705],[35.7006,139.5718],[35.7002,139.5732],[35.7000,139.5745],
    [35.6994,139.5740],[35.6996,139.5710],[35.6999,139.5680],[35.7003,139.5652],
    [35.7007,139.5627],[35.7025,139.5609],[35.7032,139.5608]
  ];
  routeLine = L.polyline(routePts, { color:'#2563eb', weight:4 }).addTo(map);
  map.fitBounds(routeLine.getBounds(), { padding:[30,30] });

  map.on('click', (e)=>{
    if(!editMode || recording) return;
    routePts.push([e.latlng.lat, e.latlng.lng]);
    routeLine.setLatLngs(routePts);
    if(lastLatLng) updateCourseStatus(lastLatLng);
  });
  map.on('dragstart', ()=>{ if(follow){ follow=false; followBtn.textContent='ğŸ” è¿½å¾“ OFF'; }});
}

/* ãƒãƒƒã‚¸ & ã‚³ãƒ¼ã‚¹åˆ¤å®š */
function setBadge(state,text){ badge.className='badge '+(state||''); badge.textContent=text; }
function distToRouteMeters(lat,lng){
  if(!routePts || routePts.length<2) return null;
  const p = turf.point([lng,lat]);
  const line = turf.lineString(routePts.map(([la,ln])=>[ln,la]));
  return turf.pointToLineDistance(p, line, {units:'meters'});
}
function updateCourseStatus(latlng){
  const d = distToRouteMeters(latlng.lat, latlng.lng);
  if(d==null){ setBadge('', 'ãƒ«ãƒ¼ãƒˆæœªä½œæˆ'); return; }
  if (d<=30) setBadge('ok', `ON COURSEï¼ˆ~${Math.round(d)}mï¼‰`);
  else if (d<=60) setBadge('warn', `æ³¨æ„ï¼š${Math.round(d)}må¤–`);
  else setBadge('off', `ãƒ«ãƒ¼ãƒˆå¤–ï¼š${Math.round(d)}m`);
}

/* ãƒªãƒ—ãƒ¬ã‚¤/ãƒªã‚»ãƒƒãƒˆ */
function resetRunLayers(){
  if(tracedLine){ map.removeLayer(tracedLine); tracedLine=null; }
  traced=[]; lastAddTs=0; recording=false;
  setEditMode(false);
  setBadge('','ã‚µãƒ³ãƒ—ãƒ«ï¼šâœï¸ã§ç·¨é›†ã€â–¶ã§è¨˜éŒ²ã€â– ã§åœæ­¢ä¿å­˜ï¼ğŸ“ã§ç¾åœ¨åœ°è¿½å¾“');
}
function drawReplay(coords){
  resetRunLayers();
  if(tracedLine) map.removeLayer(tracedLine);
  tracedLine = L.polyline(coords, { color:'#ef4444', weight:5 }).addTo(map);
  map.fitBounds(L.latLngBounds(coords), { padding:[30,30] });
  setBadge('','ä¿å­˜æ¸ˆã¿ãƒ­ã‚°ã‚’è¡¨ç¤ºä¸­');
}

/* GPS */
function onPos(pos){
  const { latitude:lat, longitude:lng, accuracy:acc } = pos.coords;
  const latlng = L.latLng(lat,lng);
  lastLatLng = latlng;

  if(!dot){
    dot = L.circleMarker(latlng,{ radius:6, weight:2, color:'#2563eb', fillColor:'#3b82f6', fillOpacity:1 }).addTo(map);
    accCircle = L.circle(latlng,{ radius:acc, color:'#93c5fd', weight:1, fillColor:'#bfdbfe', fillOpacity:0.25 }).addTo(map);
  }else{
    dot.setLatLng(latlng); accCircle.setLatLng(latlng).setRadius(acc);
  }
  if(follow) map.panTo(latlng,{animate:true});

  const now = Date.now();
  if(recording && acc<=ACC_LIMIT && (now-lastAddTs)>=MIN_INTERVAL_MS){
    const prev = traced[traced.length-1];
    const moved = !prev || latlng.distanceTo(L.latLng(prev[0],prev[1]))>=MIN_MOVE;
    if(moved){
      traced.push([lat,lng]); lastAddTs=now;
      if(tracedLine) tracedLine.setLatLngs(traced);
      else tracedLine = L.polyline(traced,{ color:'#ef4444', weight:5 }).addTo(map);
    }
  }
  updateCourseStatus(latlng);
}
function onErr(){ showToast('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼'); clearWatchIfAny(); }

/* ãƒœã‚¿ãƒ³ */
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const followBtn= document.getElementById('followBtn');
const locateBtn= document.getElementById('locateBtn');
const editToggleBtn=document.getElementById('editToggleBtn');

function setEditMode(on){
  editMode = !!on;
  editToggleBtn.textContent = editMode ? 'âœ… ç·¨é›†çµ‚äº†ï¼ˆãƒ­ãƒƒã‚¯ï¼‰' : 'âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
}
startBtn.onclick = ()=>{
  if(!('geolocation' in navigator)){ alert('ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“'); return; }
  follow = true; followBtn.textContent='ğŸ” è¿½å¾“ ON';
  clearWatchIfAny();
  window.watchId = navigator.geolocation.watchPosition(onPos, onErr, { enableHighAccuracy:true, maximumAge:0, timeout:20000 });

  setEditMode(false);
  recording = true; traced=[]; lastAddTs=0;
  if(tracedLine){ map.removeLayer(tracedLine); tracedLine=null; }
  window.__logStartedAt = new Date().toISOString();
  setBadge('warn','è¨˜éŒ²ä¸­ï¼šã‚ªãƒ³ã‚³ãƒ¼ã‚¹åˆ¤å®šæœ‰åŠ¹');
  showToast('è¨˜éŒ²ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
};
stopBtn.onclick = async ()=>{
  if(!recording){ showToast('è¨˜éŒ²ã¯é–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
  recording = false;

  // â˜… è¨˜éŒ²åœæ­¢æ™‚ã« GPS ã‚¦ã‚©ãƒƒãƒè§£é™¤
  clearWatchIfAny();

  const count = traced.length;
  const ok = confirm(`è¨˜éŒ²ã‚’åœæ­¢ã—ã¾ã™ã€‚ãƒ­ã‚°ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒã‚¤ãƒ³ãƒˆæ•°: ${count}ï¼‰`);
  if(!ok){ setBadge('','è¨˜éŒ²åœæ­¢'); showToast('ä¿å­˜ã›ãšçµ‚äº†'); window.__logStartedAt=null; return; }

  const startedAt = window.__logStartedAt || new Date().toISOString();
  const endedAt   = new Date().toISOString();
  let pts = dedupeTinyMoves(traced);
  pts = movingAverage(pts);
  const tolDeg = m2deg(6);
  let ls = turf.lineString(pts.map(([la,ln])=>[ln,la]));
  ls = turf.simplify(ls, {tolerance: tolDeg, highQuality: true});
  let simp = ls.geometry.coordinates.map(([lng,lat])=>[lat,lng]); // æ³¨æ„ï¼šturfåº§æ¨™ã¯[lng,lat]
  simp = resampleByDistance(simp, 5);

  const ls2 = turf.lineString(simp.map(([la,ln])=>[ln,la]));
  const lenMeters = turf.length(ls2,{units:'kilometers'})*1000;
  const bbox = turf.bbox(ls2);
  const polyline = encodePolyline(simp);
  const durationSec = Math.max(1, Math.round((new Date(endedAt)-new Date(startedAt))/1000));

  const nameDefault = `${ymd()} å®Ÿèµ° 01`;
  const name = prompt('å®Ÿèµ°ãƒ­ã‚°ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', nameDefault) || nameDefault;

  // Supabaseã¸ä¿å­˜
  const record = {
    name,
    startedAt, endedAt,
    polyline,
    pointCount: simp.length,
    distanceMeters: Math.round(lenMeters),
    durationSec,
    bbox
  };
  try{
    await window.dbPut('logs', record);
    showToast('ä¿å­˜ã—ã¾ã—ãŸ');
  }catch(e){
    console.error('save error', e);
    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }finally{
    window.__logStartedAt = null;     // â˜… ã‚¯ãƒªã‚¢
  }
  showHome('logs');
};

followBtn.onclick = ()=>{ follow=!follow; followBtn.textContent = follow?'ğŸ” è¿½å¾“ ON':'ğŸ” è¿½å¾“ OFF'; };
locateBtn.onclick = ()=>{
  if(!('geolocation' in navigator)) { alert('ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“'); return; }
  clearWatchIfAny();
  follow = true; followBtn.textContent='ğŸ” è¿½å¾“ ON';
  window.watchId = navigator.geolocation.watchPosition(onPos, onErr, { enableHighAccuracy:true, maximumAge:0, timeout:20000 });
};
editToggleBtn.onclick = ()=>{ if(recording){ alert('è¨˜éŒ²ä¸­ã¯ç·¨é›†ã§ãã¾ã›ã‚“'); return; } setEditMode(!editMode); };
backHomeBtn.onclick = ()=> showHome('logs');

/* åˆæœŸè¡¨ç¤º */
function init(){
  document.getElementById('tabRoutes').onclick = ()=> setHomeTab('routes');
  document.getElementById('tabLogs').onclick   = ()=> setHomeTab('logs');
  btnGoRun.addEventListener('click', ()=> showRun()); // â˜… JSå´ã§ã®ã¿ç™»éŒ²ï¼ˆé‡è¤‡å›é¿ï¼‰
  setHomeTab('logs');
}
document.addEventListener('DOMContentLoaded', init, { once:true });
</script>

<!-- Service Workerï¼ˆä»»æ„ï¼‰ -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('Service Worker registered:', reg))
      .catch(err => console.error('Service Worker registration failed:', err));
  }
</script>

</body>
</html>