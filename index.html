<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Route MVP – 実走ログ保存（IndexedDB+Fallback）</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<style>
  :root { --bg:#fff; --fg:#111827; --muted:#6b7280; --accent:#111827; --ok:#065f46; --okbg:#d1fae5; --warn:#92400e; --warnbg:#fef3c7; --off:#991b1b; --offbg:#fee2e2; }
  html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP"; }
  #app { height:100%; display:flex; flex-direction:column; }
  header { padding:10px 12px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  header .tabs { display:flex; gap:8px; }
  .tab { padding:8px 12px; border-radius:999px; border:1px solid #e5e7eb; cursor:pointer; background:#fff; }
  .tab.active { background:#111827; color:#fff; border-color:#111827; }
  main { flex:1; display:flex; }
  #home, #run { flex:1; display:none; }
  #home.active, #run.active { display:flex; }
  #home { flex-direction:column; }
  .list { padding:12px; display:flex; flex-direction:column; gap:10px; overflow:auto; }
  .card { border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:12px; background:#fff; }
  .card.highlight { outline:3px solid #93c5fd; }
  .meta { font-size:12px; color:var(--muted); }
  .btn { border:none; border-radius:10px; padding:8px 10px; font-size:14px; cursor:pointer; }
  .btn.primary { background:#111827; color:#fff; }
  .btn.ghost { background:#fff; color:#111827; border:1px solid #e5e7eb; }
  .btn.danger { background:#ef4444; color:#fff; }
  #run { position:relative; }
  #map { position:absolute; inset:0; }
  .badgewrap { position:fixed; left:8px; right:8px; top:env(safe-area-inset-top,8px); display:flex; gap:8px; z-index:1000; }
  .badge { padding:6px 10px; border-radius:999px; font-weight:600; background:#e2e8f0; }
  .badge.ok{background:var(--okbg); color:var(--ok);}
  .badge.warn{background:var(--warnbg); color:var(--warn);}
  .badge.off{background:var(--offbg); color:var(--off);}
  .dock { position:fixed; right:8px; bottom:8px; display:flex; flex-direction:column; gap:8px; z-index:1000; }
  .btn.big { padding:12px 14px; font-weight:700; }
  .btn.stop { background:#ef4444; color:#fff; }
  .toolbar { position:fixed; left:8px; bottom:8px; z-index:1000; display:flex; gap:8px; }
  .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; z-index:1100; display:none; }
  .hint { position:fixed; left:8px; bottom:60px; background:#ffffffd8; padding:6px 10px; border-radius:10px; font-size:12px; z-index:999; }
</style>
</head>
<body>
<div id="app">
  <header>
    <div style="font-weight:700">Route MVP</div>
    <div class="tabs">
      <button class="tab active" id="tabRoutes">ルート</button>
      <button class="tab" id="tabLogs">実走ログ</button>
    </div>
    <div>
      <button id="btnGoRun" class="btn ghost" onclick="window.showRun && showRun()">すぐ実走画面へ</button>
    </div>
  </header>

  <!-- 起動確認・エラーバナー -->
  <div id="bootBanner" style="display:none;padding:8px 12px;background:#e0f2fe;color:#075985;border-bottom:1px solid #7dd3fc;">
    起動OK（イベント登録済み）
  </div>
  <div id="errBanner" style="display:none;padding:8px 12px;background:#fff7ed;color:#92400e;border-bottom:1px solid #fde68a;">
    IndexedDBが使えません。localStorageに保存します（プライベートブラウズをOFFにすると改善します）。
  </div>
  <div id="pageErr" style="display:none;padding:8px 12px;background:#fee2e2;color:#991b1b;border-bottom:1px solid #fecaca;">
    ページ内でエラーが発生しました。下部ログを確認してください。
  </div>
  <pre id="pageErrLog" style="display:none;margin:8px 12px;border:1px solid #e5e7eb;background:#f9fafb;padding:8px;border-radius:8px;max-height:180px;overflow:auto;"></pre>

  <main>
    <section id="home" class="active" aria-label="home">
      <div id="routesList" class="list" hidden></div>
      <div id="logsList" class="list" hidden></div>
    </section>
    <section id="run" aria-label="run">
      <div id="map"></div>
      <div class="badgewrap"><div id="courseBadge" class="badge">準備中…</div></div>
      <div class="dock">
        <button id="startBtn" class="btn primary big">▶ 記録開始</button>
        <button id="stopBtn" class="btn stop big">■ 停止</button>
        <button id="followBtn" class="btn ghost">🔁 追従 ON</button>
        <button id="locateBtn" class="btn ghost">📍 現在地だけ</button>
        <button id="backHomeBtn" class="btn ghost">🏠 ホームへ</button>
      </div>
      <div class="toolbar"><button id="editToggleBtn" class="btn ghost">✏️ 編集モード</button></div>
      <div class="hint">▶でGPS+記録+追従ON。■停止で保存確認→保存後はホーム（実走ログ）へ。</div>
      <div id="toast" class="toast"></div>
    </section>
  </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
<script>
// --- onerror/unhandledrejection を画面に出す ---
(function(){
  const show=(msg)=>{const b=document.getElementById('pageErr');const p=document.getElementById('pageErrLog');
    if(b) b.style.display='block'; if(p){ p.style.display='block'; p.textContent += msg + "\n"; }};
  window.addEventListener('error', (e)=>{ show(`[error] ${e.message||'unknown'} @ ${e.filename||''}:${e.lineno||''}`); });
  window.addEventListener('unhandledrejection', (e)=>{const r=e.reason; show(`[unhandled] ${r&&r.message?r.message:r}`); });
})();
</script>

<script>
/* ユーティリティ・DB・地図関連の既存コードは省略せず全部入れる（ここでは略） */
/* === ここに前回までの全スクリプト本体（utils, storage fallback, home UI, run map, start/stop etc.）が続きます === */

/* =========================
   4) 初期表示（iOSでも確実に起動）
========================= */
async function init(){
  document.getElementById('tabRoutes').onclick = ()=> setHomeTab('routes');
  document.getElementById('tabLogs').onclick   = ()=> setHomeTab('logs');
  document.getElementById('btnGoRun').onclick  = ()=> showRun();
  const bb=document.getElementById('bootBanner'); if(bb) bb.style.display='block';
  try{ await openDB(); }catch(e){}
  setHomeTab('logs');
}
document.addEventListener('DOMContentLoaded', init, { once:true });
window.addEventListener('load', ()=>{ if(!window.__booted){ window.__booted=true; init(); }}, { once:true });
</script>
</body>
</html>