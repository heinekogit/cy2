<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto;max-width:720px;margin:24px auto;padding:0 12px;color:#111827}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0;background:#fff}
    label{display:block;margin-top:8px}
    input{width:100%;padding:10px;margin:6px 0;border:1px solid #d1d5db;border-radius:8px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .btn{padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer}
    .muted{color:#6b7280}
  </style>

  <script>
    window.APP_VERSION = "2025-09-23-02";
  </script>

  <!-- Supabase UMD -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = "https://cqiqhczxuiyakptdjowr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxaXFoY3p4dWl5YWtwdGRqb3dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NzAwNzMsImV4cCI6MjA3MzM0NjA3M30.vCFQoQnsClINKa5tQAz-rNnF5XLEukmn_Nl0Err5k3k";
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:false } });

    const V = () => encodeURIComponent(window.APP_VERSION || "");
    const $ = (s)=>document.querySelector(s);

    async function refreshStatus() {
      const { data:{ session } } = await client.auth.getSession();
      const user = session?.user ?? null;
      $("#status").textContent = JSON.stringify(user ? { id:user.id, email:user.email } : null, null, 2);
      if (!user) {
        $("#links").innerHTML = `<a class="btn" href="index.html?v=${V()}">トップへ</a>`;
      } else {
        $("#links").innerHTML = `
          <a class=\"btn\" href=\"index.html?v=${V()}\">トップへ</a>
          <a class=\"btn\" href=\"mypage.html?v=${V()}\">マイページへ</a>`;
      }
    }

    async function signIn() {
      const email = $("#email").value.trim();
      const password = $("#password").value;
      if (!email || !password) { alert("メール/パスワードを入力してください"); return; }
      const { error } = await client.auth.signInWithPassword({ email, password });
      if (error) { alert("Sign in error: " + error.message); return; }
      await refreshStatus();
      // 成功後はマイページへ
      window.location.href = "mypage.html?v=" + V();
    }

    async function signOut() {
      await client.auth.signOut();
      await refreshStatus();
      alert("Signed out");
    }

    async function init() {
      $("#btnSignIn").onclick = signIn;
      $("#btnSignOut").onclick = signOut;
      await refreshStatus();
      client.auth.onAuthStateChange(async ()=>{ await refreshStatus(); });
    }
    document.addEventListener("DOMContentLoaded", init, { once:true });
  </script>
</head>
<body>
  <h1>Login</h1>

  <div class="card">
    <label>メール</label>
    <input id="email" type="email" placeholder="you@example.com" />
    <label>パスワード</label>
    <input id="password" type="password" placeholder="••••••••" />
    <div class="row">
      <button class="btn" id="btnSignIn">Sign in</button>
      <button class="btn" id="btnSignOut">Sign out</button>
    </div>
  </div>

  <div class="card">
    <strong>現在の状態</strong>
    <pre id="status" class="muted">loading...</pre>
    <div id="links" class="row"></div>
  </div>

  <footer class="muted">v: <script>document.write(window.APP_VERSION)</script></footer>
</body>
</html>

