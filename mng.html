<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>実走ログ確認（IndexedDB + localStorage 対応）</title>
<style>
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, ui-sans-serif, sans-serif; }
  button, input, select { font: inherit; }
  /* 管理UIのオーバーレイ */
  #adminConsole { display:none; position:fixed; inset:0; background:#0008; z-index:99999; }
  .admin-wrap { max-width:1100px; margin:24px auto; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 8px 40px #0004; }
  .admin-bar { display:flex; align-items:center; gap:12px; padding:12px 16px; background:#111; color:#fff; }
  .admin-bar strong { font-weight:700; }
  .admin-bar .right { margin-left:auto; display:flex; gap:8px; }
  .admin-body { padding:12px 16px; }
  .admin-controls { display:flex; gap:16px; align-items:end; flex-wrap:wrap; }
  .admin-table { margin-top:12px; max-height:48vh; overflow:auto; border:1px solid #ddd; border-radius:6px; }
  table { width:100%; border-collapse:collapse; font-size:14px; }
  thead { position:sticky; top:0; background:#fafafa; }
  th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; }
  .admin-detail { display:flex; gap:16px; margin-top:12px; }
  #adminDetail { flex:1; min-height:160px; font:12px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  #adminLog { margin-top:8px; font:12px/1.6 ui-monospace, monospace; white-space:pre-wrap; color:#333; }
  .danger { background:#f5c842; }
  .btn-danger { background:#ff6b6b; color:#fff; }
  .btn-warn { background:#d7263d; color:#fff; }
</style>
</head>
<body>

<!-- Admin Console (IDB + localStorage) -->
<div id="adminConsole">
  <div class="admin-wrap">
    <div class="admin-bar">
      <strong>Admin Console</strong>
      <span id="adminStatus" style="opacity:.85; font-size:12px;"></span>
      <div class="right">
        <button id="btnAdminReload" title="再読込">再読込</button>
        <button id="btnAdminIntegrity" title="整合性チェック">整合性チェック</button>
        <button id="btnAdminDanger" class="danger" title="危険操作の表示/非表示">危険操作OFF</button>
        <button id="btnAdminClose" title="閉じる">閉じる ✕</button>
      </div>
    </div>

    <div class="admin-body">
      <div class="admin-controls">
        <div>
          <label>ビュー</label><br>
          <select id="adminView">
            <option value="logs">logs（IDB: 実走ログ）</option>
            <option value="tracks">tracks（IDB: 旧実走ログ）</option>
            <option value="runs">runs（localStorage: 実走ログ・旧MVP）</option>
            <option value="routes">routes（localStorage: コース定義）</option>
          </select>
        </div>
        <div>
          <label>検索</label><br>
          <input id="adminQuery" placeholder="id / name / date など部分一致" style="min-width:280px;">
        </div>
        <div>
          <button id="btnAdminExportJson" title="現在ビューの全件をJSONで保存">JSON書き出し</button>
          <button id="btnAdminExportCsv" title="runsビュー限定">CSV書き出し（runs）</button>
        </div>
        <div id="dangerOps" style="display:none;">
          <button id="btnAdminDeleteSelected" class="btn-danger">選択削除</button>
          <button id="btnAdminWipeAll" class="btn-warn">全消去（表示中のみ）</button>
        </div>
      </div>

      <div class="admin-table">
        <table id="adminTable">
          <thead>
            <tr>
              <th><input type="checkbox" id="adminChkAll"></th>
              <th>id</th>
              <th>name/date</th>
              <th>distance/time</th>
              <th>routeId</th>
            </tr>
          </thead>
          <tbody id="adminTbody"></tbody>
        </table>
      </div>

      <div class="admin-detail">
        <textarea id="adminDetail" placeholder="行をクリックすると詳細JSONを表示"></textarea>
      </div>

      <div id="adminLog"></div>
    </div>
  </div>
</div>

<script>
// ===== ユーティリティ（画面出力） =====
function setStatus(msg){ document.getElementById('adminStatus').textContent = msg || ''; }
function logInfo(msg){  document.getElementById('adminLog').textContent = String(msg || ''); }
function logError(heading, err){
  const detail = (err && (err.stack || err.message)) ? "\n--- detail ---\n" + (err.stack || err.message) : "";
  document.getElementById('adminLog').textContent = "✖ " + heading + detail;
  setStatus('ERROR');
}

// ===== IndexedDB helpers =====
function idbOpen(){
  return new Promise(resolve=>{
    const req = indexedDB.open('route_mvp', 1);
    req.onupgradeneeded = (e)=>{
      const db = e.target.result;
      if(!db.objectStoreNames.contains('logs'))   db.createObjectStore('logs',   {keyPath:'id'});
      if(!db.objectStoreNames.contains('tracks')) db.createObjectStore('tracks', {keyPath:'id'});
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror  = ()=> resolve(null);
  });
}
async function idbGetAll(store){
  const db = await idbOpen();
  if(!db) throw new Error('IndexedDB が使用不可（ブラウザ設定/プライベートモード等）');
  if(!db.objectStoreNames.contains(store)){
    throw new Error('objectStore "' + store + '" が存在しません（このオリジンでは未作成 or 別ストアに保存）');
  }
  return await new Promise((resolve, reject)=>{
    try{
      const tx = db.transaction(store,'readonly');
      const st = tx.objectStore(store);
      const q = st.getAll();
      q.onsuccess = ()=> resolve(q.result || []);
      q.onerror   = ()=> reject(new Error('getAll() に失敗しました'));
    }catch(e){ reject(e); }
  });
}
async function idbPutAll(store, arr){
  const db = await idbOpen();
  if(!db) throw new Error('IndexedDB が使用不可');
  await Promise.all((arr||[]).map(o=>new Promise(res=>{
    const tx = db.transaction(store,'readwrite');
    const st = tx.objectStore(store);
    const p = st.put(o);
    p.onsuccess = ()=>res();
    p.onerror   = ()=>res();
  })));
}

// ===== localStorage helpers =====
function loadArray(key){ try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){ return []; } }
function saveArray(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }
function fmt(v){ return (v==null || v==='') ? '-' : v; }

// ===== Admin Console MVP =====
(function(){
  const el = (q, r=document)=>r.querySelector(q);
  const els= (q, r=document)=>Array.from(r.querySelectorAll(q));
  const $root = el('#adminConsole');
  const $view = el('#adminView');
  const $query = el('#adminQuery');
  const $tbody = el('#adminTbody');
  const $detail = el('#adminDetail');
  const $chkAll = el('#adminChkAll');
  const $dangerOps = el('#dangerOps');

  let danger = false;
  let rows = [];   // 描画キャッシュ
  let view = 'logs';

  function render(){
    try{
      view = $view.value;
      const q = ($query.value||'').toLowerCase();
      let allPromise;
      if(view === 'logs' || view === 'tracks'){
        allPromise = idbGetAll(view);
      } else {
        allPromise = Promise.resolve(loadArray(view));
      }

      allPromise.then(all=>{
        rows = (all||[]).filter(o=>{
          if(!q) return true;
          return JSON.stringify(o).toLowerCase().includes(q);
        });

        // 兼用表示
        const z = n => String(n).padStart(2,'0');
        const fmtDuration = (sec)=>{
          sec = Number(sec);
          if(!Number.isFinite(sec) || sec<=0) return '-';
          const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=Math.floor(sec%60);
          return h>0 ? `${h}:${z(m)}:${z(s)}` : `${m}:${z(s)}`;
        };
        const fmtDateTime = (ms)=> {
          const n = Number(ms);
          return Number.isFinite(n) ? new Date(n).toLocaleString() : (ms ? String(ms) : '-');
        };

        $tbody.innerHTML = rows.map((o,i)=>{
          const name  = o.title ?? o.name ?? o.id ?? '-';
          const date  = fmtDateTime(o.createdAt ?? o.date ?? null);
          const distM = Number.isFinite(o.distanceMeters) ? o.distanceMeters
                       : (Number.isFinite(o.distance_km) ? o.distance_km*1000 : NaN);
          const distS = Number.isFinite(distM) ? `${(distM/1000).toFixed(2)} km` : '-';
          const durS  = fmtDuration(Number.isFinite(o.durationSec) ? o.durationSec : o.moving_time);
          return (
            `<tr data-idx="${i}" style="border-bottom:1px solid #f1f1f1;">
               <td><input type="checkbox" class="adminRowChk"></td>
               <td><button class="adminViewBtn" data-idx="${i}">${fmt(o.id)}</button></td>
               <td>${name} / ${date}</td>
               <td>${distS} / ${durS}</td>
               <td>${fmt(o.routeId)}</td>
             </tr>`
          );
        }).join('');

        setStatus(`view=${view} / ${rows.length}件`);
        if ((all||[]).length === 0){
          if (view==='logs' || view==='tracks'){
            logInfo(
`0 件です。
考えられる理由:
- このオリジン（${location.origin}）では保存されていない
- 保存先のストアが "${view==='logs'?'tracks':'logs'}" 側にある
- 実走保存時にエラーが出て保存されなかった`
            );
          } else {
            logInfo('0 件です（localStorage にデータがありません）');
          }
        } else {
          logInfo(`取得 ${all.length} 件 → 絞り込み後 ${rows.length} 件`);
        }

        $detail.value = '';
        $chkAll.checked = false;
      }).catch(err=>{
        logError(`データ取得に失敗（view=${view}）`, err);
        $tbody.innerHTML = '';
      });
    }catch(err){
      logError('render() 例外', err);
    }
  }

  function open(){ $root.style.display='block'; render(); }
  function close(){ $root.style.display='none'; }

  function showDetail(idx){
    const obj = rows[idx];
    if(!obj) return;
    $detail.value = JSON.stringify(obj, null, 2);
  }

  // 整合性チェック
  function integrity(){
    try{
      const routes = loadArray('routes');
      const runs = (view==='runs') ? loadArray('runs') : [];
      const routeIds = new Set(routes.map(r=>r.id).filter(Boolean));
      const idSet = new Set();
      const errs = [];

      runs.forEach((r, i)=>{
        if(!r.id) errs.push(`runs[${i}]: idなし`);
        else if(idSet.has(r.id)) errs.push(`runs[${i}]: id重複 (${r.id})`);
        else idSet.add(r.id);

        if(r.routeId && !routeIds.has(r.routeId)){
          errs.push(`runs[${i}]: routeId参照不整合 (${r.routeId})`);
        }
      });

      if(!routes.every(r=>r.id)) errs.push('routes: id未設定の要素あり');
      logInfo(errs.length ? '✖ 整合性NG:\n' + errs.join('\n') : '✓ 整合性OK');
    }catch(err){
      logError('整合性チェック失敗', err);
    }
  }

  // Export JSON / CSV
  function download(filename, text){
    const blob = new Blob([text], {type:'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.download = filename;
    a.href = url;
    a.click();
    URL.revokeObjectURL(url);
  }
  function exportJson(){
    const p = (view==='logs' || view==='tracks') ? idbGetAll(view) : Promise.resolve(loadArray(view));
    p.then(arr => {
      download(`${view}.json`, JSON.stringify(arr, null, 2));
      logInfo(`JSON 出力: ${view} / ${arr.length}件`);
    }).catch(err=> logError('JSON書き出し失敗', err));
  }
  function exportCsvRuns(){
    if(view!=='runs'){ alert('runsビューで実行してください'); return; }
    const arr = loadArray('runs');
    const cols = ['id','title','date','distance_km','moving_time','pace','routeId','note'];
    const head = cols.join(',');
    const body = arr.map(o=>cols.map(k=>{
      const v = o[k]==null? '' : String(o[k]).replaceAll('"','""');
      return /[",\n]/.test(v) ? `"${v}"` : v;
    }).join(',')).join('\n');
    download(`runs_${new Date().toISOString().slice(0,10)}.csv`, head+'\n'+body+'\n');
    logInfo(`CSV 出力: runs / ${arr.length}件`);
  }

  // 危険操作（デフォOFF）
  function toggleDanger(){
    danger = !danger;
    el('#btnAdminDanger').textContent = danger? '危険操作ON' : '危険操作OFF';
    $dangerOps.style.display = danger? 'block':'none';
  }
  function getSelectedIndices(){
    return els('.adminRowChk', $tbody).map((c,i)=> c.checked? i : -1).filter(i=>i>=0);
  }
  function deleteSelected(){
    if(!danger) return;
    const idxs = new Set(getSelectedIndices());
    if(!idxs.size){ alert('選択がありません'); return; }
    if(!confirm(`${idxs.size}件を削除します。よろしいですか？`)) return;

    const arr = (view==='logs' || view==='tracks') ? null : loadArray(view);
    if(!arr){ alert('IDBビューの削除は未実装です'); return; }
    const idsToDel = Array.from(idxs).map(i=>rows[i]?.id).filter(Boolean);
    const filtered = arr.filter(o => !idsToDel.includes(o.id));
    saveArray(view, filtered);
    render();
  }
  function wipeAll(){
    if(!danger) return;
    if(!confirm(`表示中の ${view} を全消去します。よろしいですか？`)) return;
    const arr = (view==='logs' || view==='tracks') ? null : [];
    if(arr===null){ alert('IDBビューの全消去は未実装です'); return; }
    saveArray(view, arr);
    render();
  }

  // events
  el('#btnAdminClose').onclick = close;
  el('#btnAdminReload').onclick = render;
  el('#btnAdminIntegrity').onclick = integrity;
  el('#btnAdminExportJson').onclick = exportJson;
  el('#btnAdminExportCsv').onclick = exportCsvRuns;
  el('#btnAdminDanger').onclick = toggleDanger;
  el('#btnAdminDeleteSelected').onclick = deleteSelected;
  el('#btnAdminWipeAll').onclick = wipeAll;

  $view.onchange = render;
  $query.oninput = ()=>{ render(); };
  $chkAll.onchange = ()=>{
    els('.adminRowChk', $tbody).forEach(c=> c.checked = $chkAll.checked);
  };
  $tbody.addEventListener('click', (e)=>{
    const b = e.target.closest('.adminViewBtn');
    if(b){ showDetail(Number(b.dataset.idx||0)); }
  });

  // 起動方法：?admin=1 または Alt+A
  if(new URLSearchParams(location.search).get('admin') === '1'){
    open();
  }
  window.addEventListener('keydown', (ev)=>{
    if(ev.altKey && ev.key.toLowerCase()==='a'){
      if($root.style.display==='none') open(); else close();
    }
  });
})();
</script>

</body>
</html>
